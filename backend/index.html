<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sal√£o IA - Sistema Inteligente</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            transition: background 0.3s;
        }

        body.professional-active {
            background: linear-gradient(135deg, #f0f4f8 0%, #e9eef5 100%);
            padding: 40px 20px;
        }

        .login-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 400px;
            width: 100%;
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .login-container.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #666;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 10px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .switch-auth {
            text-align: center;
            margin-top: 20px;
            color: #666;
            font-size: 14px;
        }

        .switch-auth a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        .switch-auth a:hover {
            text-decoration: underline;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .app-container {
            display: none;
            width: 100%;
            max-width: 1400px;
        }

        .app-container.active {
            display: block;
        }

        .app-header {
            background: white;
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .app-header h1 {
            color: #667eea;
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info span {
            color: #666;
        }

        .logout-btn {
            padding: 8px 20px;
            background: #f56565;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .logout-btn:hover {
            background: #e53e3e;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 22px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .badge-demo {
            background: #feebc8;
            color: #7c2d12;
        }

        .badge-ai {
            background: #bee3f8;
            color: #2c5282;
        }

        .button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .button:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .file-upload {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .file-upload:hover {
            background: #f7fafc;
            border-color: #764ba2;
        }

        .file-upload.drag-over {
            background: #edf2f7;
            border-color: #764ba2;
            transform: scale(1.02);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #bee3f8;
            color: #2c5282;
        }

        .alert-warning {
            background: #feebc8;
            color: #7c2d12;
        }

        .alert-danger {
            background: #fed7d7;
            color: #742a2a;
        }

        .recommendations {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .recommendation-card {
            background: #f7fafc;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #667eea;
        }

        .recommendation-card h4 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .recommendation-card ul {
            list-style: none;
            padding: 0;
        }

        .recommendation-card li {
            padding: 8px 0;
            color: #2d3748;
            border-bottom: 1px solid #e2e8f0;
        }

        .recommendation-card li:last-child {
            border-bottom: none;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            text-align: center;
        }

        .modal-content h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .modal-content p {
            color: #666;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div class="login-container active" id="loginContainer">
        <div class="login-header">
            <h1>üé® Sal√£o IA</h1>
            <p id="authSubtitle">Entre com sua conta</p>
        </div>

        <div class="error-message" id="authError"></div>

        <form id="authForm" onsubmit="return false;">
            <div class="form-group" id="nameGroup" style="display: none;">
                <label for="nome">Nome Completo</label>
                <input type="text" id="nome" placeholder="Seu nome">
            </div>

            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" placeholder="seu@email.com" required>
            </div>

            <div class="form-group">
                <label for="senha">Senha</label>
                <input type="password" id="senha" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
            </div>

            <button type="submit" class="login-btn" id="authButton" onclick="handleAuth()">
                <span id="authButtonText">Entrar</span>
                <span id="authButtonLoading" class="loading hidden"></span>
            </button>

            <div class="switch-auth">
                <span id="switchAuthText">N√£o tem conta?</span>
                <a id="switchAuthLink" onclick="toggleAuthMode()">Criar conta</a>
            </div>
        </form>
    </div>

    <!-- MODAL SESSION EXPIRED -->
    <div class="modal" id="sessionExpiredModal">
        <div class="modal-content">
            <h3>üîí Sess√£o Expirada</h3>
            <p>Sua sess√£o expirou. Por favor, fa√ßa login novamente.</p>
            <button class="button" onclick="closeModalAndLogin()">Fazer Login</button>
        </div>
    </div>

    <!-- APP -->
    <div class="app-container" id="appContainer">
        <div class="app-header">
            <h1>üé® Sal√£o IA</h1>
            <div class="user-info">
                <span>Ol√°, <strong id="userName">Utilizador</strong></span>
                <span class="badge badge-ai" id="userRole">cliente</span>
                <button class="logout-btn" onclick="logout()">Sair</button>
            </div>
        </div>

        <div class="card">
            <h2>üì∏ An√°lise Facial Inteligente <span class="badge badge-demo" id="aiModeBadge">Modo Demo</span></h2>
            
            <div id="aiStatus" class="alert alert-info">
                <strong>‚ÑπÔ∏è Status:</strong> <span id="statusMessage">Sistema em modo demo</span>
            </div>

            <p style="color: #666; margin-bottom: 20px;">
                Fa√ßa upload de uma foto para receber recomenda√ß√µes personalizadas!
            </p>

            <div class="file-upload" id="fileUpload">
                <input type="file" id="photoInput" accept="image/*" style="display:none">
                <div>
                    <p style="font-size: 48px;">üì∑</p>
                    <p style="font-weight: 600;">Clique ou arraste uma foto aqui</p>
                    <p style="font-size: 12px; color: #718096;">PNG, JPG at√© 5MB</p>
                </div>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="useProfilePhoto">
                <label for="useProfilePhoto" style="margin: 0; cursor: pointer;">Usar foto de perfil existente</label>
            </div>

            <button class="button" id="analyzeBtn" onclick="analyzePhoto()">
                <span id="analyzeText">Analisar com IA</span>
                <span id="analyzeLoading" class="loading hidden"></span>
            </button>

            <div id="analysisResults" class="hidden">
                <h3 style="margin-top: 30px; color: #667eea;">‚ú® Seus Resultados</h3>
                
                <div style="margin: 20px 0; padding: 15px; background: #f7fafc; border-radius: 8px;">
                    <p><strong>Formato do Rosto:</strong> <span id="faceShape" style="color: #667eea;">-</span></p>
                    <p><strong>Tom de Pele:</strong> <span id="skinTone" style="color: #667eea;">-</span></p>
                    <p><strong>Confian√ßa:</strong> <span id="confidence">-</span>%</p>
                </div>

                <div class="recommendations">
                    <div class="recommendation-card">
                        <h4>‚úÇÔ∏è Cortes Recomendados</h4>
                        <ul id="recommendedCuts"></ul>
                    </div>
                    
                    <div class="recommendation-card">
                        <h4>üé® Cores Recomendadas</h4>
                        <ul id="recommendedColors"></ul>
                    </div>
                    
                    <div class="recommendation-card">
                        <h4>üí° Dicas de Estilo</h4>
                        <ul id="styleTips"></ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üìÖ Agendamentos</h2>
            <button onclick="showAppointmentsScreen()" class="button" style="width: 100%; margin-top: 10px;">
                üìÖ Ver Meus Agendamentos
            </button>
        </div>
    </div>

    <!-- ==================== TELA DE AGENDAMENTOS ==================== -->
    <div id="appointmentsScreen" style="display: none; max-width: 1000px; margin: 0 auto;">
        <!-- Header -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 20px 20px 0 0; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <button onclick="hideAppointmentsScreen()" 
                        style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                    ‚Üê Voltar
                </button>
                <button onclick="startNewBooking()" 
                        style="background: white; color: #667eea; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                    ‚ûï Novo Agendamento
                </button>
            </div>
            <div style="display: flex; align-items: center; gap: 16px;">
                <div style="font-size: 48px;">üìÖ</div>
                <div>
                    <h1 style="margin: 0; font-size: 32px; font-weight: 700;">Meus Agendamentos</h1>
                    <p style="margin: 8px 0 0 0; opacity: 0.9;">Gerencie seus hor√°rios</p>
                </div>
            </div>
        </div>
        
        <div style="background: #f7fafc; padding: 30px; border-radius: 0 0 20px 20px;">
            <div id="appointmentsListScreen"></div>
        </div>
    </div>

    <script>
        // Configura√ß√µes da API
        const API_URL = 'http://localhost:8000';
        const API_BASE = 'http://localhost:8000/api/v1';
        
        let authToken = localStorage.getItem('auth_token');
        let isLoginMode = true;

        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ App iniciado');
            checkAuth();
            setupFileUpload();
        });

        // ==================== AUTH ====================
        function checkAuth() {
            const token = localStorage.getItem('auth_token');
            const user = localStorage.getItem('user');

            if (token && user) {
                authToken = token;
                showApp();
                checkAIStatus();
            } else {
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('loginContainer').classList.add('active');
            document.getElementById('appContainer').classList.remove('active');
            document.getElementById('appointmentsScreen').style.display = 'none';
        }

        function showApp() {
    try {
        console.log('üöÄ Mostrando app principal...');
        
        document.getElementById('loginContainer').classList.remove('active');
        
        const userStr = localStorage.getItem('user');
        if (!userStr) {
            console.error('‚ùå Usu√°rio n√£o encontrado no localStorage');
            showError('Erro ao carregar dados do usu√°rio. Tente novamente.');
            return;
        }
        
        const user = JSON.parse(userStr);
        console.log('üë§ Usu√°rio:', user.email, 'Role:', user.role);
        
        // NOVA DETEC√á√ÉO DE PROFISSIONAL
        if (user.role === 'profissional') {
            console.log('üë®‚Äçüíº Detectado profissional, mostrando painel profissional');
            showProfessionalScreen();
            return;
        }
        
        // C√≥digo do cliente continua igual...
        console.log('üë• Detectado cliente, mostrando app de cliente');
        document.getElementById('appContainer').classList.add('active');
        document.getElementById('appointmentsScreen').style.display = 'none';
        
        const userNameEl = document.getElementById('userName');
        const userRoleEl = document.getElementById('userRole');
        
        if (userNameEl) {
            userNameEl.textContent = user.nome || user.email;
        }
        if (userRoleEl) {
            userRoleEl.textContent = user.role || 'cliente';
        }
        
        console.log('‚úÖ App cliente carregado com sucesso');
    } catch (error) {
        console.error('‚ùå Erro ao mostrar app:', error);
        showError('Erro ao carregar a aplica√ß√£o. Tente novamente.');
        // Mostrar tela de login novamente
        showLogin();
    }
}


function showProfessionalScreen() {
    document.body.classList.add('professional-active');
    document.getElementById('loginContainer').classList.remove('active');
    document.getElementById('appContainer').classList.remove('active');
    document.getElementById('appointmentsScreen').style.display = 'none';
    document.getElementById('professionalScreen').classList.add('active');
    
    const user = JSON.parse(localStorage.getItem('user'));
    document.getElementById('profName').textContent = user.nome || user.email;
    
    loadProfessionalAppointments();
}

function loadProfessionalAppointments() {
    const allAppointments = JSON.parse(localStorage.getItem('user_appointments') || '[]');
    const user = JSON.parse(localStorage.getItem('user'));
    
    const available = allAppointments.filter(a => 
        a.status === 'scheduled' && 
        !a.profissional_id
    );
    
    const myAppointments = allAppointments.filter(a => 
        a.profissional_id === user.id &&
        a.status === 'scheduled'
    );
    
    const completed = allAppointments.filter(a => 
        a.profissional_id === user.id &&
        a.status === 'completed'
    );
    
    document.getElementById('availableCount').textContent = available.length;
    document.getElementById('myCount').textContent = myAppointments.length;
    document.getElementById('completedCount').textContent = completed.length;
    
    renderAvailableAppointmentsForProf(available);
    renderMyAppointmentsForProf(myAppointments);
    renderCompletedAppointmentsForProf(completed);
}

function renderAvailableAppointmentsForProf(appointments) {
    const container = document.getElementById('availableAppointments');
    
    if (appointments.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; background: white; border-radius: 20px;">üì≠ Nenhum agendamento dispon√≠vel</div>';
        return;
    }
    
container.innerHTML = appointments.map((apt) => {  // ‚Üê REMOVE index, ADICIONA clientName
    const clientName = apt.client_name || 'Novo Cliente';
    const hasQuestionnaire = apt.medical_questionnaire;
    const isRisk = hasQuestionnaire && (apt.medical_questionnaire.q2 === 'sim' || apt.medical_questionnaire.q4 === 'sim');
        
        return `
            <div class="appointment-card" style="${isRisk ? 'border: 3px solid #fc8181; background: #fff5f5;' : ''}">
                <h3>Cliente: ${apt.client_name || 'Novo Cliente'}</h3>
                <p>üìÖ ${apt.appointment_date} | ‚è∞ ${apt.appointment_time}</p>
                
                <div style="margin: 15px 0;">
                    <strong>Servi√ßos:</strong>
                    <ul style="margin: 5px 0; padding-left: 20px;">
                        ${apt.services.map(s => `<li>${s.name} - ‚Ç¨${s.price}</li>`).join('')}
                    </ul>
                </div>
                
                ${hasQuestionnaire ? `
                    <div style="background: ${isRisk ? '#fed7d7' : '#c6f6d5'}; padding: 12px; border-radius: 8px; margin: 10px 0;">
                        <strong>${isRisk ? '‚ö†Ô∏è ATEN√á√ÉO: RISCO' : '‚úÖ Question√°rio OK'}</strong>
                        <button onclick="viewQuestionnaire('${apt.booking_code}')" style="display: block; width: 100%; margin-top: 8px; padding: 8px; background: white; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            üëÅÔ∏è Ver Question√°rio
                        </button>
                    </div>
                ` : '<div style="background: #e2e8f0; padding: 12px; border-radius: 8px; font-size: 14px;">üìã Sem question√°rio m√©dico</div>'}
                
                <p style="font-size: 18px; font-weight: 700; color: #667eea; margin: 15px 0;"><strong>Total: ‚Ç¨${apt.total_price}</strong></p>
                
                <button class="button-primary" onclick="acceptAppointmentAsProf('${apt.booking_code}', '${clientName}')" ${isRisk ? 'disabled style="opacity: 0.5; cursor: not-allowed; background: #cbd5e0;"' : ''}>
                    ${isRisk ? 'üö® N√ÉO ACEITAR - CLIENTE COM RISCO' : '‚úÖ Atribuir a Mim'}
                </button>
            </div>
        `;
    }).join('');
}

function showQuestionnaireModalForProf(index) {
    const appointments = JSON.parse(localStorage.getItem('user_appointments') || '[]');
    const available = appointments.filter(a => a.status === 'scheduled' && !a.profissional_id);
    const apt = available[index];
    const q = apt.medical_questionnaire;
    
    if (!q) {
        alert('‚ùå Este agendamento n√£o tem question√°rio m√©dico.');
        return;
    }
    
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 2px solid #e2e8f0;">
                <h2 style="color: #667eea; margin: 0;">üìã Question√°rio de Sa√∫de Capilar</h2>
                <button onclick="this.closest('.modal').remove()" style="background: #f56565; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 22px;">√ó</button>
            </div>
            
            <div style="background: #fff5eb; padding: 18px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #ed8936;">
                <strong style="color: #7c2d12;">üë§ Cliente: ${apt.client_name || 'N√£o informado'}</strong><br>
                <span style="color: #666; font-size: 13px;">Preenchido em: ${new Date(q.timestamp).toLocaleString('pt-PT')}</span>
            </div>
            
            <div style="background: #f7fafc; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                <p style="font-weight: 600; color: #2d3748; margin-bottom: 8px;">1. Tem alergia a produtos qu√≠micos?</p>
                <p style="color: #667eea; font-size: 18px; font-weight: 700;">${q.q1.toUpperCase()}</p>
                ${q.q1 === 'sim' && q.q1_details ? `<p style="color: #666; margin-top: 8px; padding: 10px; background: white; border-radius: 8px;">üìù ${q.q1_details}</p>` : ''}
            </div>
            
            <div style="background: ${q.q2 === 'sim' ? '#fed7d7' : '#f7fafc'}; padding: 20px; border-radius: 12px; margin-bottom: 15px; ${q.q2 === 'sim' ? 'border: 2px solid #fc8181;' : ''}">
                <p style="font-weight: 600; color: #2d3748; margin-bottom: 8px;">2. J√° teve rea√ß√£o al√©rgica a colora√ß√£o?</p>
                <p style="color: ${q.q2 === 'sim' ? '#c53030' : '#667eea'}; font-size: 18px; font-weight: 700;">${q.q2.toUpperCase()}</p>
                ${q.q2 === 'sim' ? '<p style="color: #c53030; font-weight: 700; margin-top: 12px; padding: 12px; background: white; border-radius: 8px;">üö® RISCO CR√çTICO - N√ÉO FAZER QU√çMICOS</p>' : ''}
            </div>
            
            <div style="background: #f7fafc; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                <p style="font-weight: 600; color: #2d3748; margin-bottom: 8px;">3. Fez procedimento qu√≠mico nos √∫ltimos 15 dias?</p>
                <p style="color: #667eea; font-size: 18px; font-weight: 700;">${q.q3.toUpperCase()}</p>
                ${q.q3 === 'sim' && q.q3_details ? `<p style="color: #ed8936; margin-top: 8px; padding: 10px; background: white; border-radius: 8px;">‚ö†Ô∏è ${q.q3_details}</p>` : ''}
            </div>
            
            <div style="background: ${q.q4 === 'sim' ? '#fed7d7' : '#f7fafc'}; padding: 20px; border-radius: 12px; margin-bottom: 15px; ${q.q4 === 'sim' ? 'border: 2px solid #fc8181;' : ''}">
                <p style="font-weight: 600; color: #2d3748; margin-bottom: 8px;">4. Couro cabeludo sens√≠vel ou irritado?</p>
                <p style="color: ${q.q4 === 'sim' ? '#c53030' : '#667eea'}; font-size: 18px; font-weight: 700;">${q.q4.toUpperCase()}</p>
                ${q.q4 === 'sim' ? '<p style="color: #c53030; font-weight: 700; margin-top: 12px; padding: 12px; background: white; border-radius: 8px;">üö® RISCO CR√çTICO - N√ÉO FAZER QU√çMICOS</p>' : ''}
            </div>
            
            <div style="background: #f7fafc; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                <p style="font-weight: 600; color: #2d3748; margin-bottom: 8px;">5. Est√° gr√°vida ou amamentando?</p>
                <p style="color: #667eea; font-size: 18px; font-weight: 700;">${q.q5.toUpperCase()}</p>
            </div>
            
            ${q.observations ? `
                <div style="background: #fff5eb; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #ed8936;">
                    <strong style="color: #7c2d12;">üí¨ Observa√ß√µes do Cliente:</strong>
                    <p style="margin-top: 10px; color: #2d3748;">${q.observations}</p>
                </div>
            ` : ''}
            
            ${q.q2 === 'sim' || q.q4 === 'sim' ? `
                <div style="background: #fed7d7; border: 3px solid #c53030; padding: 25px; border-radius: 12px; margin-bottom: 20px;">
                    <strong style="color: #c53030; font-size: 18px;">üö® RECOMENDA√á√ÉO PROFISSIONAL:</strong>
                    <p style="margin-top: 12px; color: #742a2a; font-weight: 600; line-height: 1.6;">
                        N√ÉO realize procedimentos qu√≠micos neste cliente. H√° risco de rea√ß√£o al√©rgica grave. 
                        Oriente o cliente a procurar um dermatologista antes de qualquer procedimento qu√≠mico.
                    </p>
                </div>
            ` : ''}
            
            <button onclick="this.closest('.modal').remove()" class="button-primary" style="width: 100%;">
                Fechar
            </button>
        </div>
    `;
    
    document.body.appendChild(modal);
}
function viewQuestionnaire(bookingCode) {
    const appointments = JSON.parse(localStorage.getItem('user_appointments') || '[]');
    const apt = appointments.find(a => a.booking_code === bookingCode);
    
    console.log('üîç Buscando question√°rio para:', bookingCode);
    console.log('üìã Agendamento encontrado:', apt);
    
    if (!apt) {
        alert('‚ùå Agendamento n√£o encontrado.');
        return;
    }
    
    if (!apt.medical_questionnaire) {
        alert('‚ùå Este agendamento n√£o tem question√°rio m√©dico.');
        return;
    }
    
    const q = apt.medical_questionnaire;
    console.log('üìù Question√°rio:', q);
    
    // Criar modal
    const modal = document.createElement('div');
    modal.className = 'modal active';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <h2 style="color: #667eea; margin: 0;">üìã Question√°rio M√©dico</h2>
                <button onclick="this.closest('.modal').remove()" style="background: #f56565; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 22px;">√ó</button>
            </div>
            
            <div style="background: #fff5eb; padding: 18px; border-radius: 12px; margin-bottom: 20px;">
                <strong>üë§ Cliente: ${apt.client_name || 'N√£o informado'}</strong><br>
                <span style="color: #666; font-size: 13px;">Preenchido: ${new Date(q.timestamp).toLocaleString('pt-PT')}</span>
            </div>
            
            <div style="background: #f7fafc; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                <p style="font-weight: 600; color: #2d3748; margin-bottom: 8px;">1. Alergia a qu√≠micos?</p>
                <p style="color: #667eea; font-size: 18px; font-weight: 700;">${q.q1.toUpperCase()}</p>
                ${q.q1 === 'sim' && q.q1_details ? `<p style="color: #666; margin-top: 8px;">üìù ${q.q1_details}</p>` : ''}
            </div>
            
            <div style="background: ${q.q2 === 'sim' ? '#fed7d7' : '#f7fafc'}; padding: 20px; border-radius: 12px; margin-bottom: 15px; ${q.q2 === 'sim' ? 'border: 2px solid #fc8181;' : ''}">
                <p style="font-weight: 600; color: #2d3748; margin-bottom: 8px;">2. Rea√ß√£o al√©rgica anterior?</p>
                <p style="color: ${q.q2 === 'sim' ? '#c53030' : '#667eea'}; font-size: 18px; font-weight: 700;">${q.q2.toUpperCase()}</p>
                ${q.q2 === 'sim' ? '<p style="color: #c53030; font-weight: 700; margin-top: 12px;">üö® RISCO CR√çTICO</p>' : ''}
            </div>
            
            <div style="background: #f7fafc; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                <p style="font-weight: 600; color: #2d3748; margin-bottom: 8px;">3. Procedimento nos √∫ltimos 15 dias?</p>
                <p style="color: #667eea; font-size: 18px; font-weight: 700;">${q.q3.toUpperCase()}</p>
                ${q.q3 === 'sim' && q.q3_details ? `<p style="color: #ed8936; margin-top: 8px;">‚ö†Ô∏è ${q.q3_details}</p>` : ''}
            </div>
            
            <div style="background: ${q.q4 === 'sim' ? '#fed7d7' : '#f7fafc'}; padding: 20px; border-radius: 12px; margin-bottom: 15px; ${q.q4 === 'sim' ? 'border: 2px solid #fc8181;' : ''}">
                <p style="font-weight: 600; color: #2d3748; margin-bottom: 8px;">4. Couro cabeludo sens√≠vel?</p>
                <p style="color: ${q.q4 === 'sim' ? '#c53030' : '#667eea'}; font-size: 18px; font-weight: 700;">${q.q4.toUpperCase()}</p>
                ${q.q4 === 'sim' ? '<p style="color: #c53030; font-weight: 700; margin-top: 12px;">üö® RISCO CR√çTICO</p>' : ''}
            </div>
            
            <div style="background: #f7fafc; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                <p style="font-weight: 600; color: #2d3748; margin-bottom: 8px;">5. Gr√°vida/Amamentando?</p>
                <p style="color: #667eea; font-size: 18px; font-weight: 700;">${q.q5.toUpperCase()}</p>
            </div>
            
            ${q.observations ? `
                <div style="background: #fff5eb; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <strong>üí¨ Observa√ß√µes:</strong>
                    <p style="margin-top: 10px;">${q.observations}</p>
                </div>
            ` : ''}
            
            ${q.q2 === 'sim' || q.q4 === 'sim' ? `
                <div style="background: #fed7d7; border: 3px solid #c53030; padding: 25px; border-radius: 12px; margin-bottom: 20px;">
                    <strong style="color: #c53030; font-size: 18px;">üö® RECOMENDA√á√ÉO:</strong>
                    <p style="margin-top: 12px; color: #742a2a; font-weight: 600;">
                        N√ÉO realizar procedimentos qu√≠micos. Cliente com contraindica√ß√£o.
                    </p>
                </div>
            ` : ''}
            
            <button onclick="this.closest('.modal').remove()" class="button-primary">
                Fechar
            </button>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function acceptAppointmentAsProf(bookingCode, clientName) {
    const appointments = JSON.parse(localStorage.getItem('user_appointments') || '[]');
    const index = appointments.findIndex(a => a.booking_code === bookingCode);
    
    
    if (index === -1) {
        alert('‚ùå Erro: Agendamento n√£o encontrado.');
        return;
    }
    
    const user = JSON.parse(localStorage.getItem('user'));
    
    // IMPORTANTE: Salvar o nome do cliente
    appointments[index].profissional_id = user.id;
    appointments[index].profissional_name = user.nome || user.email;
    appointments[index].accepted_at = new Date().toISOString();
    appointments[index].client_name = clientName; // ‚Üê ESTA LINHA √â CRUCIAL
    
    localStorage.setItem('user_appointments', JSON.stringify(appointments));
    
    alert(`‚úÖ Agendamento aceito!\nüë§ Cliente: ${clientName}`);
    loadProfessionalAppointments();
}

function acceptAppointmentAsProf(bookingCode, clientName) {
    const appointments = JSON.parse(localStorage.getItem('user_appointments') || '[]');
    const index = appointments.findIndex(a => a.booking_code === bookingCode);
    
    if (index === -1) {
        alert('‚ùå Erro: Agendamento n√£o encontrado.');
        return;
    }
    
    const user = JSON.parse(localStorage.getItem('user'));
    
    appointments[index].profissional_id = user.id;
    appointments[index].profissional_name = user.nome || user.email;
    appointments[index].accepted_at = new Date().toISOString();
    appointments[index].client_name = clientName;
    
    localStorage.setItem('user_appointments', JSON.stringify(appointments));
    
    console.log('‚úÖ Agendamento aceito:', appointments[index]);
    
    alert(`‚úÖ Agendamento aceito!\nüë§ Cliente: ${clientName}`);
    
    // Recarregar dados
    loadProfessionalAppointments();
    
    // ADICIONAR: Mudar automaticamente para "Meus Atendimentos"
    setTimeout(() => {
        showProfessionalTab('my-appointments');
    }, 100);
}
function renderMyAppointmentsForProf(appointments) {
    const container = document.getElementById('myAppointments');
    
    if (appointments.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 60px 20px; background: white; border-radius: 20px; color: #718096;">üì≠ Voc√™ ainda n√£o aceitou nenhum agendamento</div>';
        return;
    }
    
    container.innerHTML = appointments.map(apt => `
        <div class="appointment-card" style="border: 2px solid #48bb78;">
            <div style="background: #48bb78; color: white; padding: 8px 16px; border-radius: 12px; display: inline-block; margin-bottom: 15px; font-weight: 700;">
                ‚úÖ CONFIRMADO
            </div>
            
            <h3 style="color: #2d3748; margin-bottom: 10px;">üë§ ${apt.client_name || 'Cliente'}</h3>
            <p style="color: #718096; margin: 8px 0;">üìÖ ${apt.appointment_date} | ‚è∞ ${apt.appointment_time}</p>
            
            <div style="margin: 15px 0; background: #f7fafc; padding: 15px; border-radius: 10px;">
                <strong style="color: #667eea;">‚ú® Servi√ßos:</strong>
                <ul style="margin: 8px 0; padding-left: 20px;">
                    ${apt.services.map(s => `<li style="color: #2d3748;">${s.name} (${s.duration}min - ‚Ç¨${s.price})</li>`).join('')}
                </ul>
            </div>
            
            <p style="font-size: 20px; font-weight: 700; color: #667eea; margin: 15px 0;">üí∞ Total: ‚Ç¨${apt.total_price}</p>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                ${apt.medical_questionnaire ? `
                    <button onclick="showQuestionnaireForAppointment('${apt.booking_code}')" 
                            style="flex: 1; padding: 12px; background: #edf2f7; color: #2d3748; border: 2px solid #e2e8f0; border-radius: 10px; font-weight: 600; cursor: pointer; min-width: 150px;">
                        üìã Question√°rio
                    </button>
                ` : ''}
                
                <button class="button-primary" onclick="markAsCompletedProf('${apt.booking_code}')" style="flex: 1; margin-top: 0; min-width: 150px;">
                    ‚úÖ Conclu√≠do
                </button>
            </div>
        </div>
    `).join('');
}

function renderCompletedAppointmentsForProf(appointments) {
    const container = document.getElementById('completedAppointments');
    
    if (appointments.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 60px 20px; background: white; border-radius: 20px; color: #718096;">‚úîÔ∏è Voc√™ ainda n√£o concluiu nenhum atendimento</div>';
        return;
    }
    
    container.innerHTML = appointments.map(apt => `
        <div class="appointment-card" style="border: 2px solid #718096;">
            <div style="background: #718096; color: white; padding: 8px 16px; border-radius: 12px; display: inline-block; margin-bottom: 15px; font-weight: 700;">
                ‚úîÔ∏è CONCLU√çDO
            </div>
            
            <h3 style="color: #2d3748; margin-bottom: 10px;">üë§ ${apt.client_name || 'Cliente'}</h3>
            <p style="color: #718096; margin: 8px 0;">üìÖ ${apt.appointment_date} | ‚è∞ ${apt.appointment_time}</p>
            
            <div style="background: #f0f4f8; padding: 12px; border-radius: 8px; margin: 10px 0; font-size: 13px; color: #667eea;">
                ‚úÖ Finalizado em: ${new Date(apt.completed_at).toLocaleDateString('pt-PT')} √†s ${new Date(apt.completed_at).toLocaleTimeString('pt-PT', {hour: '2-digit', minute:'2-digit'})}
            </div>
            
            <div style="margin: 15px 0; background: #f7fafc; padding: 15px; border-radius: 10px;">
                <strong style="color: #667eea;">‚ú® Servi√ßos:</strong>
                <ul style="margin: 8px 0; padding-left: 20px;">
                    ${apt.services.map(s => `<li style="color: #2d3748;">${s.name} (${s.duration}min - ‚Ç¨${s.price})</li>`).join('')}
                </ul>
            </div>
            
            <p style="font-size: 20px; font-weight: 700; color: #667eea; margin: 15px 0;">üí∞ Total: ‚Ç¨${apt.total_price}</p>
            
            ${apt.medical_questionnaire ? `
                <button onclick="showQuestionnaireForAppointment('${apt.booking_code}')" 
                        style="width: 100%; padding: 12px; background: #edf2f7; color: #2d3748; border: 2px solid #e2e8f0; border-radius: 10px; font-weight: 600; cursor: pointer; margin-bottom: 10px;">
                    üìã Ver Question√°rio
                </button>
            ` : ''}
        </div>
    `).join('');
}

function showQuestionnaireForAppointment(bookingCode) {
    const appointments = JSON.parse(localStorage.getItem('user_appointments') || '[]');
    const apt = appointments.find(a => a.booking_code === bookingCode);
    
    if (!apt) {
        alert('‚ùå Agendamento n√£o encontrado.');
        return;
    }
    
    if (!apt.medical_questionnaire) {
        alert('‚ùå Este agendamento n√£o tem question√°rio m√©dico.');
        return;
    }
    
    viewQuestionnaire(bookingCode);
}

function markAsCompletedProf(bookingCode) {
    const appointments = JSON.parse(localStorage.getItem('user_appointments') || '[]');
    const aptIndex = appointments.findIndex(a => a.booking_code === bookingCode);
    
    if (aptIndex === -1) return;
    
    const apt = appointments[aptIndex];
    
    // ‚úÖ Se tem servi√ßos que requerem teste, mostrar modal para informar resultado
    if (apt.requires_test || (apt.services && apt.services.some(s => s.requiresTest))) {
        showStrandTestResultModal(bookingCode);
        return;
    }
    
    // Caso contr√°rio, concluir direto
    completeAppointmentDirect(bookingCode);
}

function showStrandTestResultModal(bookingCode) {
    const existing = document.getElementById('strandTestResultModal');
    if (existing) existing.remove();
    
    const modal = document.createElement('div');
    modal.id = 'strandTestResultModal';
    modal.className = 'modal active';
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px; text-align: left;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e2e8f0;">
                <h2 style="color: #667eea; margin: 0;">üß™ Resultado do Teste de Mecha</h2>
                <button onclick="closeStrandTestModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #718096;">√ó</button>
            </div>
            
            <div style="background: #fff5eb; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ed8936;">
                <strong style="color: #c05621;">‚ö†Ô∏è Obrigat√≥rio:</strong> Informe o resultado do teste de mecha para concluir o atendimento
            </div>
            
            <form id="strandTestResultForm">
                <div style="margin-bottom: 20px; padding: 20px; background: #f7fafc; border-radius: 12px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 12px; color: #2d3748;">Resultado do Teste de Mecha</label>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; background: white;">
                            <input type="radio" name="testResult" value="positivo" required style="width: 18px; height: 18px; margin-right: 12px; cursor: pointer;">
                            <div>
                                <div style="font-weight: 600; color: #c53030;">üî¥ POSITIVO (Sensibilidade/Rea√ß√£o)</div>
                                <div style="font-size: 12px; color: #718096;">Observada rea√ß√£o ou sensibilidade no teste</div>
                            </div>
                        </label>
                        
                        <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; background: white;">
                            <input type="radio" name="testResult" value="negativo" required style="width: 18px; height: 18px; margin-right: 12px; cursor: pointer;">
                            <div>
                                <div style="font-weight: 600; color: #38a169;">üü¢ NEGATIVO (Sem Rea√ß√µes)</div>
                                <div style="font-size: 12px; color: #718096;">Nenhuma rea√ß√£o observada, cliente pode prosseguir</div>
                            </div>
                        </label>
                        
                        <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; background: white;">
                            <input type="radio" name="testResult" value="adiado" required style="width: 18px; height: 18px; margin-right: 12px; cursor: pointer;">
                            <div>
                                <div style="font-weight: 600; color: #ed8936;">üü° ADIADO (Reagendar)</div>
                                <div style="font-size: 12px; color: #718096;">Teste ser√° reagendado para data futura</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px; padding: 20px; background: #f7fafc; border-radius: 12px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d3748;">Observa√ß√µes (opcional)</label>
                    <textarea id="testObservations" rows="3" placeholder="Ex: Cliente com irrita√ß√£o leve, aplicar produto X..." style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;"></textarea>
                </div>
                
                <div style="display: flex; gap: 12px;">
                    <button type="button" onclick="closeStrandTestModal()" class="button" style="flex: 1; background: #e2e8f0; color: #2d3748;">Cancelar</button>
                    <button type="submit" class="button" style="flex: 2;">‚úÖ Confirmar e Concluir</button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    document.getElementById('strandTestResultForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const testResult = document.querySelector('input[name="testResult"]:checked').value;
        const observations = document.getElementById('testObservations').value;
        closeStrandTestModal();
        completeAppointmentWithStrandTest(bookingCode, testResult, observations);
    });
}

function closeStrandTestModal() {
    const modal = document.getElementById('strandTestResultModal');
    if (modal) modal.remove();
}

function completeAppointmentDirect(bookingCode) {
    if (!confirm('Marcar este atendimento como conclu√≠do?')) return;
    
    const appointments = JSON.parse(localStorage.getItem('user_appointments') || '[]');
    const index = appointments.findIndex(a => a.booking_code === bookingCode);
    
    if (index === -1) return;
    
    appointments[index].status = 'completed';
    appointments[index].completed_at = new Date().toISOString();
    
    localStorage.setItem('user_appointments', JSON.stringify(appointments));
    
    // ‚úÖ EXPORTAR PARA DATABRICKS
    try {
        const apt = appointments[index];
        fetch(`${API_BASE}/appointments/export-completed`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(apt)
        }).catch(err => console.warn('‚ö†Ô∏è Aviso ao exportar:', err));
    } catch (error) {
        console.warn('‚ö†Ô∏è Aviso ao exportar para Databricks:', error);
    }
    
    alert('‚úÖ Atendimento conclu√≠do com sucesso!');
    loadProfessionalAppointments();
}

function completeAppointmentWithStrandTest(bookingCode, testResult, observations) {
    const appointments = JSON.parse(localStorage.getItem('user_appointments') || '[]');
    const index = appointments.findIndex(a => a.booking_code === bookingCode);
    
    if (index === -1) return;
    
    appointments[index].status = 'completed';
    appointments[index].completed_at = new Date().toISOString();
    appointments[index].strand_test_result = {
        result: testResult,
        observations: observations,
        tested_at: new Date().toISOString()
    };
    
    localStorage.setItem('user_appointments', JSON.stringify(appointments));
    
    // ‚úÖ EXPORTAR PARA DATABRICKS (com resultado do teste)
    try {
        const apt = appointments[index];
        fetch(`${API_BASE}/appointments/export-completed`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(apt)
        }).catch(err => console.warn('‚ö†Ô∏è Aviso ao exportar:', err));
    } catch (error) {
        console.warn('‚ö†Ô∏è Aviso ao exportar para Databricks:', error);
    }
    
    alert(`‚úÖ Atendimento conclu√≠do!\n\nüß™ Resultado do Teste: ${testResult.toUpperCase()}${observations ? '\nüìù Observa√ß√µes: ' + observations : ''}`);
    loadProfessionalAppointments();
}

function showProfessionalTab(tab) {
    console.log('üîÑ Mudando para tab:', tab);
    
    // Remover active de todas as tabs
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    
    // Adicionar active na tab clicada
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(t => {
        const text = t.textContent;
        if ((tab === 'available' && text.includes('Dispon√≠veis')) ||
            (tab === 'my-appointments' && text.includes('Meus Atendimentos')) ||
            (tab === 'completed' && text.includes('Conclu√≠dos'))) {
            t.classList.add('active');
        }
    });
    
    // Mostrar/ocultar conte√∫do
    const tabAvailable = document.getElementById('tabAvailable');
    const tabMyAppointments = document.getElementById('tabMyAppointments');
    const tabCompleted = document.getElementById('tabCompleted');
    
    if (tabAvailable) tabAvailable.style.display = tab === 'available' ? 'block' : 'none';
    if (tabMyAppointments) tabMyAppointments.style.display = tab === 'my-appointments' ? 'block' : 'none';
    if (tabCompleted) tabCompleted.style.display = tab === 'completed' ? 'block' : 'none';
    
    console.log('‚úÖ Tab alterada para:', tab);
}

console.log('‚úÖ Patch do painel profissional carregado!');

// ==================== AGENDAMENTO PELO PROFISSIONAL ====================

function openScheduleForClientModal() {
    const existing = document.getElementById('scheduleClientModal');
    if (existing) existing.remove();
    
    const modal = document.createElement('div');
    modal.id = 'scheduleClientModal';
    modal.className = 'modal active';
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; text-align: left;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #e2e8f0;">
                <h2 style="color: #667eea; margin: 0;">üìÖ Agendar Novo Cliente</h2>
                <button onclick="closeScheduleForClientModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #718096;">√ó</button>
            </div>
            
            <form id="scheduleClientForm">
                <!-- SE√á√ÉO DE CLIENTE -->
                <fieldset style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                    <legend style="color: #667eea; font-weight: 700; padding: 0 10px;">üë§ Dados do Cliente</legend>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d3748;">Nome</label>
                        <input type="text" id="clientName" required placeholder="Nome completo do cliente" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d3748;">Email</label>
                        <input type="email" id="clientEmail" placeholder="email@example.com" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d3748;">Telefone</label>
                        <input type="tel" id="clientPhone" placeholder="+351 912345678" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
                    </div>
                </fieldset>
                
                <!-- SE√á√ÉO DE AGENDAMENTO -->
                <fieldset style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                    <legend style="color: #667eea; font-weight: 700; padding: 0 10px;">üìÖ Data e Hora</legend>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d3748;">Data</label>
                        <input type="date" id="scheduleDate" required style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2d3748;">Hora</label>
                        <select id="scheduleTime" required style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
                            <option value="">Selecione a data primeiro...</option>
                        </select>
                    </div>
                </fieldset>
                
                <!-- SE√á√ÉO DE SERVI√áOS -->
                <fieldset style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                    <legend style="color: #667eea; font-weight: 700; padding: 0 10px;">‚ú® Servi√ßos</legend>
                    <div id="servicesList" style="display: grid; gap: 12px; max-height: 300px; overflow-y: auto;"></div>
                    <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <div style="display: flex; justify-content: space-between;">
                            <div><strong style="color: #718096; font-size: 13px;">Total</strong></div>
                            <div style="font-size: 20px; font-weight: 700; color: #667eea;">‚Ç¨<span id="professTotalPrice">0</span></div>
                        </div>
                        <div style="color: #718096; font-size: 13px; margin-top: 5px;"><span id="professTotalDuration">0 min</span></div>
                    </div>
                </fieldset>
                
                <!-- SE√á√ÉO DE OBSERVA√á√ïES -->
                <fieldset style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                    <legend style="color: #667eea; font-weight: 700; padding: 0 10px;">üìù Observa√ß√µes</legend>
                    <textarea id="scheduleNotes" rows="3" placeholder="Alguma observa√ß√£o especial?" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;"></textarea>
                </fieldset>
                
                <div style="display: flex; gap: 12px;">
                    <button type="button" onclick="closeScheduleForClientModal()" class="button" style="flex: 1; background: #e2e8f0; color: #2d3748;">Cancelar</button>
                    <button type="submit" class="button" style="flex: 2;">‚úÖ Agendar Cliente</button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Preencher data m√≠nima (hoje)
    document.getElementById('scheduleDate').min = new Date().toISOString().split('T')[0];
    
    // Carregar servi√ßos dispon√≠veis
    loadServicesForProfessional();
    
    // Event listeners
    document.getElementById('scheduleDate').addEventListener('change', loadTimeSlotsForSchedule);
    document.getElementById('scheduleClientForm').addEventListener('submit', submitProfessionalSchedule);
}

function loadServicesForProfessional() {
    const container = document.getElementById('servicesList');
    if (!container) return;
    
    let html = '';
    Object.entries(SERVICES_DATA).forEach(([category, services]) => {
        const categoryNames = {
            cortes: '‚úÇÔ∏è Cortes',
            coloracao: 'üé® Colora√ß√£o',
            tratamentos: 'üíÜ Tratamentos',
            manicure: 'üíÖ Manicure',
            outros: '‚ú® Outros'
        };
        
        services.forEach(service => {
            const checkboxId = `prof_service_${service.id}`;
            html += `
                <label style="display: flex; align-items: center; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; background: white;">
                    <input type="checkbox" id="${checkboxId}" value="${service.id}" onchange="updateProfessionalServiceTotal()" style="width: 18px; height: 18px; margin-right: 12px; cursor: pointer;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #2d3748;">${service.name}</div>
                        <div style="font-size: 12px; color: #718096;">‚è±Ô∏è ${service.duration}min | üí∞ ‚Ç¨${service.price}</div>
                    </div>
                </label>
            `;
        });
    });
    
    container.innerHTML = html;
}

function updateProfessionalServiceTotal() {
    const checkboxes = document.querySelectorAll('#servicesList input[type="checkbox"]:checked');
    let totalPrice = 0;
    let totalDuration = 0;
    
    checkboxes.forEach(cb => {
        const serviceId = cb.value;
        const service = findServiceById(serviceId);
        if (service) {
            totalPrice += service.price;
            totalDuration += service.duration;
        }
    });
    
    document.getElementById('professTotalPrice').textContent = totalPrice;
    document.getElementById('professTotalDuration').textContent = totalDuration + ' min';
}

function loadTimeSlotsForSchedule() {
    const dateInput = document.getElementById('scheduleDate');
    const timeSelect = document.getElementById('scheduleTime');
    
    if (!dateInput.value) return;
    
    timeSelect.innerHTML = '<option value="">Selecione um hor√°rio</option>';
    for (let hour = 9; hour < 18; hour++) {
        ['00', '30'].forEach(minute => {
            const time = `${hour.toString().padStart(2, '0')}:${minute}`;
            const option = document.createElement('option');
            option.value = time;
            option.textContent = time;
            timeSelect.appendChild(option);
        });
    }
}

function closeScheduleForClientModal() {
    const modal = document.getElementById('scheduleClientModal');
    if (modal) modal.remove();
}

async function submitProfessionalSchedule(e) {
    e.preventDefault();
    
    const clientName = document.getElementById('clientName').value;
    const clientEmail = document.getElementById('clientEmail').value;
    const clientPhone = document.getElementById('clientPhone').value;
    const appointmentDate = document.getElementById('scheduleDate').value;
    const appointmentTime = document.getElementById('scheduleTime').value;
    const notes = document.getElementById('scheduleNotes').value;
    
    if (!clientName || !appointmentDate || !appointmentTime) {
        alert('‚ö†Ô∏è Preencha os campos obrigat√≥rios!');
        return;
    }
    
    // Coletar servi√ßos selecionados
    const selectedServices = [];
    document.querySelectorAll('#servicesList input[type="checkbox"]:checked').forEach(cb => {
        const service = findServiceById(cb.value);
        if (service) selectedServices.push(service);
    });
    
    if (selectedServices.length === 0) {
        alert('‚ö†Ô∏è Selecione pelo menos um servi√ßo!');
        return;
    }
    
    const user = JSON.parse(localStorage.getItem('user'));
    
    const schedulingData = {
        client_name: clientName,
        client_email: clientEmail,
        client_phone: clientPhone,
        appointment_date: appointmentDate,
        appointment_time: appointmentTime,
        professional_id: user.id,
        professional_name: user.nome,
        services: selectedServices,
        notes: notes
    };
    
    try {
        const response = await fetch(`${API_BASE}/appointments/professional/create`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(schedulingData)
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Erro ao agendar');
        }
        
        const result = await response.json();
        
        // ‚úÖ ADICIONAR AGENDAMENTO AO LOCALSTORAGE DO PROFISSIONAL
        const newAppointment = {
            booking_code: result.booking_code,
            appointment_id: result.appointment_id,
            appointment_date: appointmentDate,
            appointment_time: appointmentTime,
            appointment_datetime: result.appointment_datetime,
            client_name: clientName,
            client_email: clientEmail || '',
            client_phone: clientPhone || '',
            professional_id: user.id,
            professional_name: user.nome,
            services: selectedServices,
            total_price: selectedServices.reduce((sum, s) => sum + (s.price || 0), 0),
            total_duration: selectedServices.reduce((sum, s) => sum + (s.duration || 0), 0),
            status: 'scheduled',
            notes: notes,
            created_by: 'professional',
            created_at: new Date().toISOString(),
            scheduled_at: new Date().toISOString()
        };
        
        // Salvar no localStorage
        let appointments = JSON.parse(localStorage.getItem('user_appointments') || '[]');
        appointments.push(newAppointment);
        localStorage.setItem('user_appointments', JSON.stringify(appointments));
        console.log('‚úÖ Agendamento salvo no localStorage do profissional');
        
        closeScheduleForClientModal();
        alert(`‚úÖ Cliente agendado com sucesso!\\n\\nüìÖ ${appointmentDate}\\n‚è∞ ${appointmentTime}\\nüé´ ${result.booking_code}`);
        
        // Recarregar agendamentos
        loadProfessionalAppointments();
        
    } catch (error) {
        console.error('‚ùå Erro:', error);
        alert(`Erro ao agendar: ${error.message}`);
    }
}

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            
            const nameGroup = document.getElementById('nameGroup');
            const subtitle = document.getElementById('authSubtitle');
            const buttonText = document.getElementById('authButtonText');
            const switchText = document.getElementById('switchAuthText');
            const switchLink = document.getElementById('switchAuthLink');

            if (isLoginMode) {
                nameGroup.style.display = 'none';
                subtitle.textContent = 'Entre com sua conta';
                buttonText.textContent = 'Entrar';
                switchText.textContent = 'N√£o tem conta?';
                switchLink.textContent = 'Criar conta';
            } else {
                nameGroup.style.display = 'block';
                subtitle.textContent = 'Crie sua conta';
                buttonText.textContent = 'Criar Conta';
                switchText.textContent = 'J√° tem conta?';
                switchLink.textContent = 'Entrar';
            }

            hideError();
        }

        async function handleAuth() {
            const email = document.getElementById('email').value;
            const senha = document.getElementById('senha').value;
            const nome = document.getElementById('nome').value;

            if (!email || !senha) {
                showError('Preencha todos os campos');
                return;
            }

            if (!isLoginMode && !nome) {
                showError('Preencha seu nome');
                return;
            }

            setAuthLoading(true);

            try {
                if (isLoginMode) {
                    console.log('üîê Iniciando login...');
                    await login(email, senha);
                    console.log('‚úÖ Login conclu√≠do com sucesso');
                } else {
                    console.log('üìù Iniciando registro...');
                    await register(nome, email, senha);
                    console.log('‚úÖ Registro conclu√≠do com sucesso');
                }
            } catch (error) {
                console.error('‚ùå Erro na autentica√ß√£o:', error);
                showError(error.message || 'Erro ao processar autentica√ß√£o. Tente novamente.');
            } finally {
                setAuthLoading(false);
            }
        }

        async function login(email, senha) {
            const formData = new URLSearchParams();
            formData.append('username', email);
            formData.append('password', senha);

            console.log('üì§ Login:', email);

            const response = await fetch(`${API_BASE}/auth/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData
            });

            console.log('üì• Response:', response.status);

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Erro ao fazer login');
            }

            const data = await response.json();
            console.log('‚úÖ Login OK');
            
            localStorage.setItem('auth_token', data.access_token);
            localStorage.setItem('user', JSON.stringify(data.user));
            authToken = data.access_token;
            
            showApp();
            
            // ‚úÖ Chamar checkAIStatus SEM AWAIT (n√£o bloqueia o fluxo)
            checkAIStatus().catch(err => console.warn('‚ö†Ô∏è Aviso ao verificar IA:', err));
        }

        async function register(nome, email, senha) {
            const response = await fetch(`${API_BASE}/auth/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    nome: nome,
                    email: email,
                    senha: senha,
                    role: 'cliente'
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Erro ao criar conta');
            }

            await login(email, senha);
        }

        function logout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user');
            authToken = null;
            document.body.classList.remove('professional-active');
            console.log('üëã Logout');
            showLogin();
        }

        function handleSessionExpired() {
            console.log('üîí Sess√£o expirada');
            document.getElementById('sessionExpiredModal').classList.add('active');
        }

        function closeModalAndLogin() {
            document.getElementById('sessionExpiredModal').classList.remove('active');
            logout();
        }

        function setAuthLoading(loading) {
            const button = document.getElementById('authButton');
            const text = document.getElementById('authButtonText');
            const loadingIcon = document.getElementById('authButtonLoading');

            button.disabled = loading;
            text.classList.toggle('hidden', loading);
            loadingIcon.classList.toggle('hidden', !loading);
        }

        function showError(message) {
            const errorEl = document.getElementById('authError');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }

        function hideError() {
            const errorEl = document.getElementById('authError');
            errorEl.classList.remove('show');
        }

        // ==================== AI ====================
        async function checkAIStatus() {
            try {
                console.log('ü§ñ Verificando IA');
                
                // Timeout de 5 segundos para n√£o bloquear UI
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch(`${API_BASE}/ai/status`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeout);
                
                if (response.status === 401) {
                    console.warn('‚ö†Ô∏è N√£o autorizado para verificar IA');
                    return;
                }
                
                if (!response.ok) {
                    console.warn(`‚ö†Ô∏è Erro ao verificar IA: ${response.status}`);
                    return;
                }
                
                const data = await response.json();
                console.log('‚úÖ Status IA:', data);
                
                const statusEl = document.getElementById('statusMessage');
                const badgeEl = document.getElementById('aiModeBadge');
                
                if (statusEl && badgeEl) {
                    if (data.ai_demo_mode) {
                        statusEl.textContent = 'Sistema em modo demo. An√°lises gen√©ricas dispon√≠veis.';
                        badgeEl.textContent = 'Modo Demo';
                        badgeEl.className = 'badge badge-demo';
                    } else if (data.facial_analysis_available) {
                        statusEl.textContent = 'An√°lise facial com IA ativada!';
                        badgeEl.textContent = 'IA Ativa';
                        badgeEl.className = 'badge badge-ai';
                    }
                }
            } catch (error) {
                // Log apenas como aviso, n√£o como erro
                console.warn('‚ö†Ô∏è Aviso ao verificar status IA:', error.message);
                // N√£o interrompe o fluxo de login
            }
        }

        function setupFileUpload() {
            const fileUpload = document.getElementById('fileUpload');
            const fileInput = document.getElementById('photoInput');

            fileUpload.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    console.log('üìÅ Arquivo:', file.name);
                    
                    fileUpload.querySelector('div').innerHTML = `
                        <p style="font-size: 48px;">‚úÖ</p>
                        <p style="font-weight: 600;">Foto: ${file.name}</p>
                        <p style="font-size: 12px; color: #718096;">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                    `;
                }
            });

            fileUpload.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUpload.classList.add('drag-over');
            });

            fileUpload.addEventListener('dragleave', () => {
                fileUpload.classList.remove('drag-over');
            });

            fileUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUpload.classList.remove('drag-over');
                
                if (e.dataTransfer.files.length > 0) {
                    fileInput.files = e.dataTransfer.files;
                    fileInput.dispatchEvent(new Event('change'));
                }
            });
        }

        async function analyzePhoto() {
            const fileInput = document.getElementById('photoInput');
            const useProfilePhoto = document.getElementById('useProfilePhoto').checked;
            
            if (!fileInput.files[0] && !useProfilePhoto) {
                alert('Selecione uma foto ou marque "Usar foto de perfil"');
                return;
            }

            if (!authToken) {
                handleSessionExpired();
                return;
            }

            document.getElementById('analyzeText').classList.add('hidden');
            document.getElementById('analyzeLoading').classList.remove('hidden');
            document.getElementById('analyzeBtn').disabled = true;

            try {
                const formData = new FormData();
                
                if (fileInput.files[0]) {
                    formData.append('file', fileInput.files[0]);
                }
                
                const url = `${API_BASE}/ai/analyze?use_profile_photo=${useProfilePhoto}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });

                if (response.status === 401) {
                    handleSessionExpired();
                    return;
                }

                if (!response.ok) {
                    throw new Error(`Erro ${response.status}`);
                }

                const data = await response.json();
                displayAnalysisResults(data);

            } catch (error) {
                console.error('‚ùå Erro:', error);
                alert(`Erro: ${error.message}`);
            } finally {
                document.getElementById('analyzeText').classList.remove('hidden');
                document.getElementById('analyzeLoading').classList.add('hidden');
                document.getElementById('analyzeBtn').disabled = false;
            }
        }

        function displayAnalysisResults(data) {
            window.currentRecommendations = data;
            
            document.getElementById('faceShape').textContent = data.formato_rosto.toUpperCase();
            document.getElementById('skinTone').textContent = data.tom_pele.toUpperCase();
            document.getElementById('confidence').textContent = ((data.confianca || 0) * 100).toFixed(0);

            const cutsEl = document.getElementById('recommendedCuts');
            cutsEl.innerHTML = '';
            (data.cortes_sugeridos || []).slice(0, 5).forEach(cut => {
                const li = document.createElement('li');
                li.textContent = cut;
                cutsEl.appendChild(li);
            });

            const colorsEl = document.getElementById('recommendedColors');
            colorsEl.innerHTML = '';
            (data.cores_sugeridas || []).slice(0, 5).forEach(color => {
                const li = document.createElement('li');
                li.textContent = color;
                colorsEl.appendChild(li);
            });

            const tipsEl = document.getElementById('styleTips');
            tipsEl.innerHTML = '';
            (data.dicas_estilo || []).slice(0, 3).forEach(tip => {
                const li = document.createElement('li');
                li.textContent = tip;
                tipsEl.appendChild(li);
            });

            document.getElementById('analysisResults').classList.remove('hidden');
            
            // Adicionar bot√µes de a√ß√£o
            addActionButtons();
            
            document.getElementById('analysisResults').scrollIntoView({ behavior: 'smooth' });
        }

// ==================== ADICIONAR ESTE C√ìDIGO NO index.html ====================
// Cole este c√≥digo ANTES da linha "// ==================== TELA DE AGENDAMENTOS ===================="

// ==================== DADOS DOS SERVI√áOS ====================

const SERVICES_DATA = {
    cortes: [
        { id: 'corte_feminino', name: 'Corte Feminino', duration: 60, price: 25 },
        { id: 'corte_masculino', name: 'Corte Masculino', duration: 30, price: 15 },
        { id: 'corte_infantil', name: 'Corte Infantil', duration: 30, price: 12 },
        { id: 'long_bob', name: 'Long Bob', duration: 60, price: 25 },
        { id: 'franja', name: 'Franja', duration: 15, price: 8 }
    ],
    coloracao: [
        { id: 'coloracao_completa', name: 'Colora√ß√£o Completa', duration: 120, price: 45, requiresTest: true },
        { id: 'retoque_raiz', name: 'Retoque de Raiz', duration: 90, price: 30, requiresTest: true },
        { id: 'luzes_mechas', name: 'Luzes/Mechas', duration: 180, price: 60, requiresTest: true },
        { id: 'balayage', name: 'Balayage', duration: 150, price: 70, requiresTest: true },
        { id: 'reflexos', name: 'Reflexos', duration: 90, price: 35, requiresTest: true }
    ],
    tratamentos: [
        { id: 'hidratacao', name: 'Hidrata√ß√£o Profunda', duration: 90, price: 35 },
        { id: 'cauterizacao', name: 'Cauteriza√ß√£o', duration: 120, price: 45, requiresTest: true },
        { id: 'reconstrucao', name: 'Reconstru√ß√£o', duration: 120, price: 50, requiresTest: true },
        { id: 'botox', name: 'Botox Capilar', duration: 150, price: 60, requiresTest: true }
    ],
    manicure: [
        { id: 'manicure_simples', name: 'Manicure Simples', duration: 30, price: 15 },
        { id: 'manicure_completa', name: 'Manicure Completa', duration: 30, price: 25 },
        { id: 'manicure_completa_gel', name: 'Manicure Completa Gel', duration: 60, price: 25 },
        { id: 'pedicure_simples', name: 'Pedicure Simples', duration: 30, price: 18 },
        { id: 'pedicure_completa', name: 'Pedicure Completa', duration: 60, price: 28 }
    ],
    outros: [
        { id: 'escova', name: 'Escova', duration: 45, price: 20 },
        { id: 'penteado', name: 'Penteado', duration: 60, price: 30 },
        { id: 'maquiagem', name: 'Maquiagem', duration: 60, price: 40 }
    ]
};

let selectedServices = [];

// ==================== BOT√ïES DE A√á√ÉO AP√ìS AN√ÅLISE ====================

function addActionButtons() {
    const resultsDiv = document.getElementById('analysisResults');
    const existing = document.getElementById('actionButtons');
    if (existing) existing.remove();
    
    const actionsDiv = document.createElement('div');
    actionsDiv.id = 'actionButtons';
    actionsDiv.style.cssText = 'margin-top: 30px; padding: 20px; background: #f7fafc; border-radius: 12px; border-left: 4px solid #667eea;';
    
    actionsDiv.innerHTML = `
        <h4 style="color: #667eea; margin-bottom: 15px;">üìÖ Pr√≥ximos Passos</h4>
        <p style="color: #666; margin-bottom: 20px;">
            Gostou das recomenda√ß√µes? Agende agora!
        </p>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="button" onclick="showAllServices()" style="background: #667eea;">
                üìã Selecionar Servi√ßos
            </button>
            <button class="button" onclick="analyzeAgain()" style="background: #ed8936;">
                üîÑ Nova An√°lise
            </button>
        </div>
    `;
    
    resultsDiv.appendChild(actionsDiv);
}

function showAllServices() {
    showServiceSelectionModal([], null);
}

function analyzeAgain() {
    const fileInput = document.getElementById('photoInput');
    fileInput.value = '';
    
    const fileUpload = document.getElementById('fileUpload');
    fileUpload.querySelector('div').innerHTML = `
        <p style="font-size: 48px;">üì∑</p>
        <p style="font-weight: 600;">Clique ou arraste uma foto aqui</p>
        <p style="font-size: 12px; color: #718096;">PNG, JPG at√© 5MB</p>
    `;
    
    document.getElementById('useProfilePhoto').checked = false;
    document.getElementById('analysisResults').classList.add('hidden');
    fileUpload.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// ==================== MODAL DE SELE√á√ÉO DE SERVI√áOS ====================

function showServiceSelectionModal(recommendedIds = [], analysisData = null) {
    const existing = document.getElementById('servicesModal');
    if (existing) existing.remove();
    
    const modal = document.createElement('div');
    modal.id = 'servicesModal';
    modal.className = 'modal active';
    
    const categoryNames = {
        cortes: '‚úÇÔ∏è Cortes',
        coloracao: 'üé® Colora√ß√£o',
        tratamentos: 'üíÜ Tratamentos',
        manicure: 'üíÖ Manicure',
        outros: '‚ú® Outros Servi√ßos'
    };
    
    let servicesHtml = '';
    Object.entries(SERVICES_DATA).forEach(([category, services]) => {
        servicesHtml += `
            <div style="margin-bottom: 30px;">
                <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">
                    ${categoryNames[category]}
                </h3>
                <div style="display: grid; gap: 12px;">
        `;
        
        services.forEach(service => {
            const checkboxId = `service_${service.id}`;
            servicesHtml += `
                <label for="${checkboxId}" style="display: flex; align-items: center; padding: 18px; border: 2px solid #e2e8f0; background: white; border-radius: 12px; cursor: pointer;">
                    <input type="checkbox" id="${checkboxId}" onchange="toggleService('${service.id}')" style="width: 22px; height: 22px; margin-right: 18px; cursor: pointer;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <strong style="color: #2d3748;">${service.name}</strong>
                            ${service.requiresTest ? '<span style="background: #ed8936; color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px;">‚ö†Ô∏è Teste 48h</span>' : ''}
                        </div>
                        <div style="color: #718096; font-size: 15px;">
                            ‚è±Ô∏è ${service.duration} min | üí∞ ‚Ç¨${service.price}
                        </div>
                    </div>
                </label>
            `;
        });
        
        servicesHtml += '</div></div>';
    });
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; text-align: left;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px; position: sticky; top: 0; background: white; padding-bottom: 15px; border-bottom: 2px solid #e2e8f0;">
                <h2 style="color: #667eea; margin: 0;">‚ú® Selecione os Servi√ßos</h2>
                <button onclick="closeServicesModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #718096;">√ó</button>
            </div>
            
            ${servicesHtml}
            
            <div style="position: sticky; bottom: 0; background: white; border-top: 2px solid #e2e8f0; padding-top: 20px; margin-top: 30px;">
                <div style="background: #f7fafc; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between;">
                        <div>
                            <div style="color: #718096; font-size: 13px;">Total</div>
                            <span id="totalPrice" style="font-size: 32px; font-weight: 700; color: #667eea;">‚Ç¨0</span>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #718096; font-size: 14px;"><span id="totalDuration">0 min</span></div>
                            <div style="color: #718096; font-size: 14px;"><span id="totalServices">0 servi√ßos</span></div>
                        </div>
                    </div>
                </div>
                
                <div id="testWarning" style="display: none; background: #fff5f5; border: 2px solid #fc8181; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                    <strong style="color: #c53030;">‚ö†Ô∏è Aten√ß√£o:</strong> Alguns servi√ßos requerem teste de mecha 48h antes.
                </div>
                
                <div style="display: flex; gap: 12px;">
                    <button onclick="closeServicesModal()" class="button" style="flex: 1; background: #e2e8f0; color: #2d3748;">Cancelar</button>
                    <button onclick="confirmServices()" class="button" style="flex: 2;">üìÖ Continuar</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    selectedServices = [];
}

function findServiceById(id) {
    for (const category in SERVICES_DATA) {
        const service = SERVICES_DATA[category].find(s => s.id === id);
        if (service) return service;
    }
    return null;
}

function toggleService(serviceId) {
    const service = findServiceById(serviceId);
    if (!service) return;
    
    const index = selectedServices.findIndex(s => s.id === serviceId);
    if (index >= 0) {
        selectedServices.splice(index, 1);
    } else {
        selectedServices.push(service);
    }
    
    updateCartSummary();
}

function updateCartSummary() {
    const totalPrice = selectedServices.reduce((sum, s) => sum + s.price, 0);
    const totalDuration = selectedServices.reduce((sum, s) => sum + s.duration, 0);
    const hasTestRequired = selectedServices.some(s => s.requiresTest);
    
    document.getElementById('totalPrice').textContent = `‚Ç¨${totalPrice}`;
    document.getElementById('totalDuration').textContent = `${totalDuration} min`;
    document.getElementById('totalServices').textContent = `${selectedServices.length} servi√ßo${selectedServices.length !== 1 ? 's' : ''}`;
    
    const testWarning = document.getElementById('testWarning');
    testWarning.style.display = hasTestRequired ? 'block' : 'none';
}

function closeServicesModal() {
    const modal = document.getElementById('servicesModal');
    if (modal) modal.remove();
    selectedServices = [];
}

function confirmServices() {
    if (selectedServices.length === 0) {
        alert('‚ö†Ô∏è Selecione pelo menos um servi√ßo!');
        return;
    }
    
    const hasTestRequired = selectedServices.some(s => s.requiresTest);
    const servicesToSave = [...selectedServices];
    
    closeServicesModal();
    
    if (hasTestRequired) {
        window.pendingServices = servicesToSave;
        showMedicalQuestionnaire();
    } else {
        proceedToBooking(servicesToSave, null);
    }
}

// ==================== QUESTION√ÅRIO M√âDICO ====================

function showMedicalQuestionnaire() {
    const existing = document.getElementById('medicalModal');
    if (existing) existing.remove();
    
    const modal = document.createElement('div');
    modal.id = 'medicalModal';
    modal.className = 'modal active';
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; text-align: left;">
            <h2 style="color: #667eea; margin-bottom: 20px;">üìã Question√°rio de Sa√∫de Capilar</h2>
            
            <div class="alert alert-danger" style="margin-bottom: 25px;">
                <strong>‚ö†Ô∏è Importante:</strong> Responda com sinceridade para sua seguran√ßa.
            </div>
            
            <form id="medicalForm">
                <div style="margin-bottom: 20px; padding: 20px; background: #f7fafc; border-radius: 12px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 12px;">1. Tem alergia a produtos qu√≠micos?</label>
                    <div style="display: flex; gap: 15px; margin-bottom: 10px;">
                        <label><input type="radio" name="q1" value="sim" required> Sim</label>
                        <label><input type="radio" name="q1" value="nao" required> N√£o</label>
                    </div>
                    <input type="text" id="q1_details" placeholder="Especifique quais..." style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; display: none;">
                </div>
                
                <div style="margin-bottom: 20px; padding: 20px; background: #f7fafc; border-radius: 12px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 12px;">2. J√° teve rea√ß√£o al√©rgica a colora√ß√£o?</label>
                    <div style="display: flex; gap: 15px;">
                        <label><input type="radio" name="q2" value="sim" required> Sim</label>
                        <label><input type="radio" name="q2" value="nao" required> N√£o</label>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px; padding: 20px; background: #f7fafc; border-radius: 12px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 12px;">3. Fez procedimento qu√≠mico nos √∫ltimos 15 dias?</label>
                    <div style="display: flex; gap: 15px; margin-bottom: 10px;">
                        <label><input type="radio" name="q3" value="sim" required> Sim</label>
                        <label><input type="radio" name="q3" value="nao" required> N√£o</label>
                    </div>
                    <input type="text" id="q3_details" placeholder="Qual procedimento?" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; display: none;">
                </div>
                
                <div style="margin-bottom: 20px; padding: 20px; background: #f7fafc; border-radius: 12px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 12px;">4. Couro cabeludo sens√≠vel ou irritado?</label>
                    <div style="display: flex; gap: 15px;">
                        <label><input type="radio" name="q4" value="sim" required> Sim</label>
                        <label><input type="radio" name="q4" value="nao" required> N√£o</label>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px; padding: 20px; background: #f7fafc; border-radius: 12px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 12px;">5. Est√° gr√°vida ou amamentando?</label>
                    <div style="display: flex; gap: 15px;">
                        <label><input type="radio" name="q5" value="sim" required> Sim</label>
                        <label><input type="radio" name="q5" value="nao" required> N√£o</label>
                        <label><input type="radio" name="q5" value="na" required> N/A</label>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px; padding: 20px; background: #f7fafc; border-radius: 12px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 12px;">Observa√ß√µes (opcional)</label>
                    <textarea id="observations" rows="3" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;"></textarea>
                </div>
                
                <div style="padding: 20px; background: #f0fff4; border: 2px solid #48bb78; border-radius: 12px; margin-bottom: 20px;">
                    <label style="display: flex; gap: 12px;">
                        <input type="checkbox" id="acceptTerms" required style="width: 20px; height: 20px;">
                        <span style="font-size: 14px;">Declaro que as informa√ß√µes s√£o verdadeiras e autorizo o teste de mecha.</span>
                    </label>
                </div>
                
                <div style="display: flex; gap: 12px;">
                    <button type="button" onclick="closeMedicalModal()" class="button" style="flex: 1; background: #e2e8f0; color: #2d3748;">Cancelar</button>
                    <button type="submit" class="button" style="flex: 2;">‚úÖ Confirmar</button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    document.querySelector('input[name="q1"][value="sim"]').onchange = () => document.getElementById('q1_details').style.display = 'block';
    document.querySelector('input[name="q1"][value="nao"]').onchange = () => document.getElementById('q1_details').style.display = 'none';
    document.querySelector('input[name="q3"][value="sim"]').onchange = () => document.getElementById('q3_details').style.display = 'block';
    document.querySelector('input[name="q3"][value="nao"]').onchange = () => document.getElementById('q3_details').style.display = 'none';
    
    document.getElementById('medicalForm').onsubmit = async (e) => {
        e.preventDefault();
        
        const q2 = document.querySelector('input[name="q2"]:checked').value;
        const q4 = document.querySelector('input[name="q4"]:checked').value;
        
        if (q2 === 'sim' || q4 === 'sim') {
            alert('‚ö†Ô∏è ATEN√á√ÉO!\n\nPara sua seguran√ßa, n√£o podemos realizar procedimentos qu√≠micos.\n\nConsulte um dermatologista primeiro.');
            closeMedicalModal();
            return;
        }
        
        const medicalData = {
            q1: document.querySelector('input[name="q1"]:checked').value,
            q1_details: document.getElementById('q1_details').value,
            q2: q2,
            q3: document.querySelector('input[name="q3"]:checked').value,
            q3_details: document.getElementById('q3_details').value,
            q4: q4,
            q5: document.querySelector('input[name="q5"]:checked').value,
            observations: document.getElementById('observations').value,
            timestamp: new Date().toISOString()
        };
        
        const servicesToBook = window.pendingServices;
        closeMedicalModal();
        proceedToBooking(servicesToBook, medicalData);
    };
}

function closeMedicalModal() {
    const modal = document.getElementById('medicalModal');
    if (modal) modal.remove();
}

// ==================== PROCESSAR AGENDAMENTO ====================

async function proceedToBooking(services, medicalData) {
    if (!services || services.length === 0) {
        alert('‚ùå Erro: Nenhum servi√ßo selecionado.');
        return;
    }
    
    const bookingData = {
        services: services,
        medical_questionnaire: medicalData,
        analysis_data: window.currentRecommendations || null,
        total_price: services.reduce((sum, s) => sum + s.price, 0),
        total_duration: services.reduce((sum, s) => sum + s.duration, 0),
        created_at: new Date().toISOString()
    };
    
    try {
        const response = await fetch(`${API_BASE}/appointments/prepare`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(bookingData)
        });
        
        if (response.ok) {
            const result = await response.json();
            showDateTimeSelector(result.booking_code, bookingData);
        } else {
            showDateTimeSelector('LOCAL-' + Date.now(), bookingData);
        }
    } catch (error) {
        showDateTimeSelector('LOCAL-' + Date.now(), bookingData);
    }
}

// ==================== SELETOR DE DATA/HORA ====================

function showDateTimeSelector(bookingCode, bookingData) {
    const existing = document.getElementById('dateTimeModal');
    if (existing) existing.remove();
    
    const modal = document.createElement('div');
    modal.id = 'dateTimeModal';
    modal.className = 'modal active';
    
    const requiresTest = bookingData.services.some(s => s.requiresTest);
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px; text-align: left;">
            <h2 style="color: #667eea; margin-bottom: 10px;">üìÖ Agendar Data e Hora</h2>
            <p style="color: #718096; margin-bottom: 20px;">C√≥digo: ${bookingCode}</p>
            
            <div style="background: #f7fafc; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                <strong>üìã Servi√ßos:</strong>
                <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                    ${bookingData.services.map(s => `<li>${s.name} (${s.duration}min - ‚Ç¨${s.price})</li>`).join('')}
                </ul>
                <div style="margin-top: 10px;">
                    <strong>üí∞ Total:</strong> ‚Ç¨${bookingData.total_price} | 
                    <strong>‚è±Ô∏è Dura√ß√£o:</strong> ${Math.floor(bookingData.total_duration/60)}h ${bookingData.total_duration%60}min
                </div>
            </div>
            
            ${requiresTest ? `
                <div class="alert alert-warning" style="margin-bottom: 20px;">
                    <strong>‚ö†Ô∏è Lembre-se:</strong> Agende teste de mecha 48h ANTES deste agendamento!
                </div>
            ` : ''}
            
            <form id="dateTimeForm">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px;">Data:</label>
                    <input type="date" id="appointmentDate" required 
                           min="${new Date().toISOString().split('T')[0]}"
                           style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px;">Hora:</label>
                    <select id="appointmentTime" required style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
                        <option value="">Selecione a data primeiro...</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px;">Observa√ß√µes (opcional):</label>
                    <textarea id="appointmentNotes" rows="3" placeholder="Algum pedido especial?" 
                              style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;"></textarea>
                </div>
                
                <div style="display: flex; gap: 12px;">
                    <button type="button" onclick="closeDateTimeModal()" class="button" style="flex: 1; background: #e2e8f0; color: #2d3748;">Cancelar</button>
                    <button type="submit" class="button" style="flex: 2;">‚úÖ Confirmar</button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    document.getElementById('appointmentDate').addEventListener('change', loadAvailableSlots);
    document.getElementById('dateTimeForm').addEventListener('submit', (e) => {
        e.preventDefault();
        confirmSchedule(bookingCode, bookingData);
    });
}

function loadAvailableSlots() {
    const dateInput = document.getElementById('appointmentDate');
    const timeSelect = document.getElementById('appointmentTime');
    
    if (!dateInput.value) return;
    
    timeSelect.innerHTML = '<option value="">Selecione um hor√°rio</option>';
    for (let hour = 9; hour < 18; hour++) {
        ['00', '30'].forEach(minute => {
            const time = `${hour.toString().padStart(2, '0')}:${minute}`;
            const option = document.createElement('option');
            option.value = time;
            option.textContent = time;
            timeSelect.appendChild(option);
        });
    }
}

function confirmSchedule(bookingCode, bookingData) {
    const date = document.getElementById('appointmentDate').value;
    const time = document.getElementById('appointmentTime').value;
    const notes = document.getElementById('appointmentNotes').value;
    
    if (!time) {
        alert('‚ö†Ô∏è Selecione um hor√°rio!');
        return;
    }
    
const user = JSON.parse(localStorage.getItem('user'));
    
    const appointment = {
        booking_code: bookingCode,
        appointment_date: date,
        appointment_time: time,
        notes: notes,
        client_name: user.nome || user.email,
        user_id: user.id,
        services: bookingData.services,
        medical_questionnaire: bookingData.medical_questionnaire,
        total_price: bookingData.total_price,
        total_duration: bookingData.total_duration,
        requires_test: bookingData.services.some(s => s.requiresTest),
        status: 'scheduled',
        created_at: new Date().toISOString()
    };
    
    let appointments = JSON.parse(localStorage.getItem('user_appointments') || '[]');
    appointments.push(appointment);
    localStorage.setItem('user_appointments', JSON.stringify(appointments));
    
    closeDateTimeModal();
    
    alert(`‚úÖ AGENDAMENTO CONFIRMADO!\n\nüìÖ Data: ${date}\n‚è∞ Hora: ${time}\nüé´ C√≥digo: ${bookingCode}`);
    
    showAppointmentsScreen();
}

function closeDateTimeModal() {
    const modal = document.getElementById('dateTimeModal');
    if (modal) modal.remove();
}
        // ==================== TELA DE AGENDAMENTOS ====================

        function showAppointmentsScreen() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('appointmentsScreen').style.display = 'block';
            loadAppointmentsForScreen();
        }

        function hideAppointmentsScreen() {
            document.getElementById('appointmentsScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
        }

        function loadAppointmentsForScreen() {
            const appointments = JSON.parse(localStorage.getItem('user_appointments') || '[]');
            const container = document.getElementById('appointmentsListScreen');
            
            if (appointments.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 64px; margin-bottom: 20px;">üìÖ</div>
                        <h3 style="color: #2d3748; margin-bottom: 10px;">Nenhum agendamento ainda</h3>
                        <p style="margin-bottom: 30px; color: #718096;">Fa√ßa sua an√°lise facial e agende um hor√°rio!</p>
                        <button onclick="startNewBooking()" class="button">
                            ‚ûï Novo Agendamento
                        </button>
                    </div>
                `;
                return;
            }
            
            appointments.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            container.innerHTML = appointments.map((apt, index) => {
                const date = new Date(apt.appointment_date);
                const formattedDate = date.toLocaleDateString('pt-PT');
                const statusColor = apt.status === 'scheduled' ? '#48bb78' : '#fc8181';
                const statusText = apt.status === 'scheduled' ? 'AGENDADO' : 'CANCELADO';
                
                return `
                    <div style="background: white; border: 3px solid ${statusColor}; border-radius: 16px; padding: 24px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid #f7fafc;">
                            <div>
                                <h3 style="margin: 0; color: #667eea; font-size: 18px;">${apt.services[0].name}</h3>
                                ${apt.services.length > 1 ? `<p style="margin: 4px 0 0 0; color: #718096; font-size: 13px;">+${apt.services.length-1} servi√ßo(s)</p>` : ''}
                            </div>
                            <div style="background: ${statusColor}; color: white; padding: 8px 16px; border-radius: 20px; font-weight: 700; font-size: 12px;">
                                ${statusText}
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 20px;">
                            <div style="background: #f7fafc; padding: 12px; border-radius: 8px;">
                                <div style="color: #718096; font-size: 12px; font-weight: 600; margin-bottom: 4px;">üìÖ DATA</div>
                                <div style="color: #2d3748; font-size: 16px; font-weight: 700;">${formattedDate}</div>
                            </div>
                            <div style="background: #f7fafc; padding: 12px; border-radius: 8px;">
                                <div style="color: #718096; font-size: 12px; font-weight: 600; margin-bottom: 4px;">üïê HOR√ÅRIO</div>
                                <div style="color: #2d3748; font-size: 16px; font-weight: 700;">${apt.appointment_time}</div>
                            </div>
                            <div style="background: #f7fafc; padding: 12px; border-radius: 8px;">
                                <div style="color: #718096; font-size: 12px; font-weight: 600; margin-bottom: 4px;">üí∞ VALOR</div>
                                <div style="color: #2d3748; font-size: 16px; font-weight: 700;">‚Ç¨${apt.total_price}</div>
                            </div>
                            <div style="background: #f7fafc; padding: 12px; border-radius: 8px;">
                                <div style="color: #718096; font-size: 12px; font-weight: 600; margin-bottom: 4px;">‚è±Ô∏è DURA√á√ÉO</div>
                                <div style="color: #2d3748; font-size: 16px; font-weight: 700;">${Math.floor(apt.total_duration/60)}h ${apt.total_duration%60}m</div>
                            </div>
                        </div>
                        
                        <div style="background: #edf2f7; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                            <strong style="color: #4a5568; font-size: 13px;">‚ú® SERVI√áOS:</strong>
                            <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                                ${apt.services.map(s => `<li style="color: #2d3748; font-size: 14px;">${s.name}</li>`).join('')}
                            </ul>
                        </div>
                        
                        ${apt.status === 'scheduled' ? `
                            <div style="display: flex; gap: 12px; padding-top: 16px; border-top: 2px solid #f7fafc;">
                                <button onclick="showAppointmentDetails(${index})" class="button" style="flex: 1;">
                                    üëÅÔ∏è Ver Detalhes
                                </button>
                                <button onclick="cancelAppointmentFromScreen(${index})" 
                                        style="flex: 1; padding: 12px; background: #fed7d7; color: #c53030; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                    ‚ùå Cancelar
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function showAppointmentDetails(index) {
            const appointments = JSON.parse(localStorage.getItem('user_appointments') || '[]');
            const apt = appointments[index];
            
            const servicesText = apt.services.map(s => `‚Ä¢ ${s.name} (${s.duration}min - ‚Ç¨${s.price})`).join('\n');
            
            alert(`üìã DETALHES DO AGENDAMENTO\n\nüìÖ Data: ${apt.appointment_date}\nüïê Hora: ${apt.appointment_time}\n\n‚ú® Servi√ßos:\n${servicesText}\n\nüí∞ Total: ‚Ç¨${apt.total_price}\n‚è±Ô∏è Dura√ß√£o: ${Math.floor(apt.total_duration/60)}h ${apt.total_duration%60}min${apt.notes ? '\n\nüìù Observa√ß√µes: ' + apt.notes : ''}`);
        }

        function cancelAppointmentFromScreen(index) {
            if (!confirm('Tem certeza que deseja cancelar este agendamento?')) return;
            
            let appointments = JSON.parse(localStorage.getItem('user_appointments') || '[]');
            appointments[index].status = 'cancelled';
            appointments[index].cancelled_at = new Date().toISOString();
            localStorage.setItem('user_appointments', JSON.stringify(appointments));
            
            alert('‚úÖ Agendamento cancelado com sucesso!');
            loadAppointmentsForScreen();
        }

        function startNewBooking() {
            hideAppointmentsScreen();
            document.getElementById('fileUpload').scrollIntoView({ behavior: 'smooth' });
        }
    </script>
   <!-- ================================================================ -->
<!-- PAINEL PROFISSIONAL -->
<!-- Cole este c√≥digo ANTES do fechamento </body> no seu index.html -->
<!-- ================================================================ -->

<div class="professional-screen" id="professionalScreen">
    <div class="professional-header" style="background: white; border-radius: 20px; padding: 25px 35px; margin-bottom: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.15);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div>
                <h1 style="color: #667eea; font-size: 28px; margin: 0;">üë®‚Äçüíº Painel do Profissional</h1>
                <p style="color: #718096; margin: 8px 0 0 0; font-size: 15px;">
                    Ol√°, <strong id="profName" style="color: #2d3748;">Profissional</strong>
                </p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="openScheduleForClientModal()" style="padding: 12px 24px; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; box-shadow: 0 5px 15px rgba(72, 187, 120, 0.3); transition: all 0.3s;">
                    üìÖ Agendar Cliente
                </button>
                <button onclick="logout()" style="padding: 12px 24px; background: linear-gradient(135deg, #f56565 0%, #c53030 100%); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; box-shadow: 0 5px 15px rgba(245, 101, 101, 0.3); transition: all 0.3s;">
                    üö™ Sair
                </button>
            </div>
        </div>
                üö™ Sair
            </button>
        </div>
        
        <div class="tabs" style="display: flex; gap: 10px; margin-top: 20px; border-bottom: 2px solid #e0e0e0;">
    <button class="tab active" onclick="showProfessionalTab('available')" style="padding: 12px 24px; background: transparent; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 600; color: #718096; transition: all 0.3s;">
        üìã Dispon√≠veis (<span id="availableCount">0</span>)
    </button>
    <button class="tab" onclick="showProfessionalTab('my-appointments')" style="padding: 12px 24px; background: transparent; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 600; color: #718096; transition: all 0.3s;">
        ‚úÖ Meus Atendimentos (<span id="myCount">0</span>)
    </button>
    <button class="tab" onclick="showProfessionalTab('completed')" style="padding: 12px 24px; background: transparent; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: 600; color: #718096; transition: all 0.3s;">
        ‚úîÔ∏è Conclu√≠dos (<span id="completedCount">0</span>)
    </button>
    </div>

    <!-- Tab: Agendamentos Dispon√≠veis -->
    <div id="tabAvailable" class="tab-content">
        <div id="availableAppointments" class="appointments-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 25px;"></div>
    </div>

    <!-- Tab: Meus Atendimentos -->
    <div id="tabMyAppointments" class="tab-content" style="display: none;">
        <div id="myAppointments" class="appointments-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 25px;"></div>
    </div>

    <!-- Tab: Conclu√≠dos -->
    <div id="tabCompleted" class="tab-content" style="display: none;">
        <div id="completedAppointments" class="appointments-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 25px;"></div>
    </div>
</div>


<style>
/* CSS ADICIONAL PARA O PAINEL PROFISSIONAL */
.professional-screen {
    display: none;
    width: 100%;
    max-width: 1400px;
    position: relative;
    z-index: 10;
}

.professional-screen.active {
    display: block;
}

.tab.active {
    color: #667eea !important;
    border-bottom-color: #667eea !important;
    background: rgba(102, 126, 234, 0.05) !important;
}

.appointment-card {
    background: white;
    border-radius: 20px;
    padding: 25px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    transition: all 0.3s;
}

.appointment-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 40px rgba(0,0,0,0.15);
}

.button-primary {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 12px;
    font-weight: 700;
    cursor: pointer;
    margin-top: 12px;
    transition: all 0.3s;
    font-size: 15px;
}

.button-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
}

.button-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

@media (max-width: 768px) {
    .appointments-grid {
        grid-template-columns: 1fr !important;
    }
}

.tab {
    padding: 12px 24px;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer !important;
    font-weight: 600;
    color: #718096;
    transition: all 0.3s;
    pointer-events: auto !important;
    z-index: 10;
}

.tab:hover {
    background: rgba(102, 126, 234, 0.05);
    color: #667eea;
}

.tab.active {
    color: #667eea !important;
    border-bottom-color: #667eea !important;
    background: rgba(102, 126, 234, 0.05) !important;
}

.tabs {
    position: relative;
    z-index: 10;
}
</style> 
</body>
</html>