<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Sal√£o IA - Sistema Inteligente v2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .login-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 400px;
            width: 100%;
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .login-container.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #666;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 10px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        .login-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .switch-auth {
            text-align: center;
            margin-top: 20px;
            color: #666;
            font-size: 14px;
        }

        .switch-auth a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        .switch-auth a:hover {
            text-decoration: underline;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .app-container {
            display: none;
            width: 100%;
            max-width: 1400px;
        }

        .app-container.active {
            display: block;
        }

        .app-header {
            background: white;
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .app-header h1 {
            color: #667eea;
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info span {
            color: #666;
        }

        .logout-btn {
            padding: 8px 20px;
            background: #f56565;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .logout-btn:hover {
            background: #e53e3e;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 22px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .badge-demo {
            background: #feebc8;
            color: #7c2d12;
        }

        .badge-ai {
            background: #bee3f8;
            color: #2c5282;
        }

        .button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .button:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .file-upload {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .file-upload:hover {
            background: #f7fafc;
            border-color: #764ba2;
        }

        .file-upload.drag-over {
            background: #edf2f7;
            border-color: #764ba2;
            transform: scale(1.02);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #bee3f8;
            color: #2c5282;
        }

        .alert-warning {
            background: #feebc8;
            color: #7c2d12;
        }

        .alert-danger {
            background: #fed7d7;
            color: #742a2a;
        }

        .recommendations {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .recommendation-card {
            background: #f7fafc;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #667eea;
        }

        .recommendation-card h4 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .recommendation-card ul {
            list-style: none;
            padding: 0;
        }

        .recommendation-card li {
            padding: 8px 0;
            color: #2d3748;
            border-bottom: 1px solid #e2e8f0;
        }

        .recommendation-card li:last-child {
            border-bottom: none;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            text-align: center;
        }

        .modal-content h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .modal-content p {
            color: #666;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div class="login-container active" id="loginContainer">
        <div class="login-header">
            <h1>üé® Sal√£o IA</h1>
            <p id="authSubtitle">Entre com sua conta</p>
        </div>

        <div class="error-message" id="authError"></div>

        <form id="authForm" onsubmit="return false;">
            <div class="form-group" id="nameGroup" style="display: none;">
                <label for="nome">Nome Completo</label>
                <input type="text" id="nome" placeholder="Seu nome">
            </div>

            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" placeholder="seu@email.com" required>
            </div>

            <div class="form-group">
                <label for="senha">Senha</label>
                <input type="password" id="senha" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
            </div>

            <button type="submit" class="login-btn" id="authButton" onclick="handleAuth()">
                <span id="authButtonText">Entrar</span>
                <span id="authButtonLoading" class="loading hidden"></span>
            </button>

            <div class="switch-auth">
                <span id="switchAuthText">N√£o tem conta?</span>
                <a id="switchAuthLink" onclick="toggleAuthMode()">Criar conta</a>
            </div>
        </form>
    </div>

    <!-- MODAL SESSION EXPIRED -->
    <div class="modal" id="sessionExpiredModal">
        <div class="modal-content">
            <h3>üîí Sess√£o Expirada</h3>
            <p>Sua sess√£o expirou. Por favor, fa√ßa login novamente.</p>
            <button class="button" onclick="closeModalAndLogin()">Fazer Login</button>
        </div>
    </div>

    <!-- APP -->
    <div class="app-container" id="appContainer">
        <div class="app-header">
            <h1>üé® Sal√£o IA</h1>
            <div class="user-info">
                <span>Ol√°, <strong id="userName">Utilizador</strong></span>
                <span class="badge badge-ai" id="userRole">cliente</span>
                <button class="logout-btn" onclick="logout()">Sair</button>
            </div>
        </div>

        <div class="card">
            <h2>üì∏ An√°lise Facial Inteligente <span class="badge badge-demo" id="aiModeBadge">Modo Demo</span></h2>
            
            <div id="aiStatus" class="alert alert-info">
                <strong>‚ÑπÔ∏è Status:</strong> <span id="statusMessage">Sistema em modo demo</span>
            </div>

            <p style="color: #666; margin-bottom: 20px;">
                Fa√ßa upload de uma foto para receber recomenda√ß√µes personalizadas!
            </p>

            <div class="file-upload" id="fileUpload">
                <input type="file" id="photoInput" accept="image/*" style="display:none">
                <div>
                    <p style="font-size: 48px;">üì∑</p>
                    <p style="font-weight: 600;">Clique ou arraste uma foto aqui</p>
                    <p style="font-size: 12px; color: #718096;">PNG, JPG at√© 5MB</p>
                </div>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="useProfilePhoto">
                <label for="useProfilePhoto" style="margin: 0; cursor: pointer;">Usar foto de perfil existente</label>
            </div>

            <button class="button" id="analyzeBtn" onclick="analyzePhoto()">
                <span id="analyzeText">Analisar com IA</span>
                <span id="analyzeLoading" class="loading hidden"></span>
            </button>

            <div id="analysisResults" class="hidden">
                <h3 style="margin-top: 30px; color: #667eea;">‚ú® Seus Resultados</h3>
                
                <div style="margin: 20px 0; padding: 15px; background: #f7fafc; border-radius: 8px;">
                    <p><strong>Formato do Rosto:</strong> <span id="faceShape" style="color: #667eea;">-</span></p>
                    <p><strong>Tom de Pele:</strong> <span id="skinTone" style="color: #667eea;">-</span></p>
                    <p><strong>Confian√ßa:</strong> <span id="confidence">-</span>%</p>
                </div>

                <div class="recommendations">
                    <div class="recommendation-card">
                        <h4>‚úÇÔ∏è Cortes Recomendados</h4>
                        <ul id="recommendedCuts"></ul>
                    </div>
                    
                    <div class="recommendation-card">
                        <h4>üé® Cores Recomendadas</h4>
                        <ul id="recommendedColors"></ul>
                    </div>
                    
                    <div class="recommendation-card">
                        <h4>üí° Dicas de Estilo</h4>
                        <ul id="styleTips"></ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üìÖ Agendamentos</h2>
            <button onclick="showAppointmentsScreen()" class="button" style="width: 100%; margin-top: 10px;">
                üìÖ Ver Meus Agendamentos
            </button>
        </div>
    </div>

    <!-- TELA DE AGENDAMENTOS -->
    <div id="appointmentsScreen" style="display: none; max-width: 1000px; margin: 0 auto;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 20px 20px 0 0; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <button onclick="hideAppointmentsScreen()" 
                        style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                    ‚Üê Voltar
                </button>
                <button onclick="startNewBooking()" 
                        style="background: white; color: #667eea; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                    ‚ûï Novo Agendamento
                </button>
            </div>
            <div style="display: flex; align-items: center; gap: 16px;">
                <div style="font-size: 48px;">üìÖ</div>
                <div>
                    <h1 style="margin: 0; font-size: 32px; font-weight: 700;">Meus Agendamentos</h1>
                    <p style="margin: 8px 0 0 0; opacity: 0.9;">Gerencie seus hor√°rios</p>
                </div>
            </div>
        </div>
        
        <div style="background: #f7fafc; padding: 30px; border-radius: 0 0 20px 20px;">
            <div id="appointmentsListScreen"></div>
        </div>
    </div>

    <script>
        // Configura√ß√µes da API
        const API_URL = 'http://localhost:8000';
        const API_BASE = 'http://localhost:8000/api/v1';
        
        let authToken = localStorage.getItem('auth_token');
        let isLoginMode = true;

        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ App iniciado - vers√£o corrigida');
            try {
                checkAuth();
                setupFileUpload();
            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o:', error);
            }
        });

        // ==================== AUTH ====================
        function checkAuth() {
            const token = localStorage.getItem('auth_token');
            const user = localStorage.getItem('user');

            if (token && user) {
                authToken = token;
                showApp();
                checkAIStatus();
            } else {
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('loginContainer').classList.add('active');
            document.getElementById('appContainer').classList.remove('active');
            document.getElementById('appointmentsScreen').style.display = 'none';
        }

        function showApp() {
            document.getElementById('loginContainer').classList.remove('active');
            document.getElementById('appContainer').classList.add('active');
            document.getElementById('appointmentsScreen').style.display = 'none';
            
            const user = JSON.parse(localStorage.getItem('user'));
            document.getElementById('userName').textContent = user.nome || user.email;
            document.getElementById('userRole').textContent = user.role || 'cliente';
        }

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            
            const nameGroup = document.getElementById('nameGroup');
            const subtitle = document.getElementById('authSubtitle');
            const buttonText = document.getElementById('authButtonText');
            const switchText = document.getElementById('switchAuthText');
            const switchLink = document.getElementById('switchAuthLink');

            if (isLoginMode) {
                nameGroup.style.display = 'none';
                subtitle.textContent = 'Entre com sua conta';
                buttonText.textContent = 'Entrar';
                switchText.textContent = 'N√£o tem conta?';
                switchLink.textContent = 'Criar conta';
            } else {
                nameGroup.style.display = 'block';
                subtitle.textContent = 'Crie sua conta';
                buttonText.textContent = 'Criar Conta';
                switchText.textContent = 'J√° tem conta?';
                switchLink.textContent = 'Entrar';
            }

            hideError();
        }

        async function handleAuth() {
            const email = document.getElementById('email').value;
            const senha = document.getElementById('senha').value;
            const nome = document.getElementById('nome').value;

            if (!email || !senha) {
                showError('Preencha todos os campos');
                return;
            }

            if (!isLoginMode && !nome) {
                showError('Preencha seu nome');
                return;
            }

            setAuthLoading(true);

            try {
                if (isLoginMode) {
                    await login(email, senha);
                } else {
                    await register(nome, email, senha);
                }
            } catch (error) {
                console.error('Erro auth:', error);
                showError(error.message);
            } finally {
                setAuthLoading(false);
            }
        }

        async function login(email, senha) {
            const formData = new URLSearchParams();
            formData.append('username', email);
            formData.append('password', senha);

            console.log('üì§ Login:', email);

            const response = await fetch(`${API_BASE}/auth/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData
            });

            console.log('üì• Response:', response.status);

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Erro ao fazer login');
            }

            const data = await response.json();
            console.log('‚úÖ Login OK');
            
            localStorage.setItem('auth_token', data.access_token);
            localStorage.setItem('user', JSON.stringify(data.user));
            authToken = data.access_token;
            
            showApp();
            checkAIStatus();
        }

        async function register(nome, email, senha) {
            const response = await fetch(`${API_BASE}/auth/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    nome: nome,
                    email: email,
                    senha: senha,
                    role: 'cliente'
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Erro ao criar conta');
            }

            await login(email, senha);
        }

        function logout() {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user');
            authToken = null;
            console.log('üëã Logout');
            showLogin();
        }

        function handleSessionExpired() {
            console.log('üîí Sess√£o expirada');
            document.getElementById('sessionExpiredModal').classList.add('active');
        }

        function closeModalAndLogin() {
            document.getElementById('sessionExpiredModal').classList.remove('active');
            logout();
        }

        function setAuthLoading(loading) {
            const button = document.getElementById('authButton');
            const text = document.getElementById('authButtonText');
            const loadingIcon = document.getElementById('authButtonLoading');

            button.disabled = loading;
            text.classList.toggle('hidden', loading);
            loadingIcon.classList.toggle('hidden', !loading);
        }

        function showError(message) {
            const errorEl = document.getElementById('authError');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }

        function hideError() {
            const errorEl = document.getElementById('authError');
            errorEl.classList.remove('show');
        }

        // ==================== AI ====================
        async function checkAIStatus() {
            try {
                console.log('ü§ñ Verificando IA');
                
                const response = await fetch(`${API_BASE}/ai/status`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.status === 401) {
                    handleSessionExpired();
                    return;
                }
                
                const data = await response.json();
                console.log('‚úÖ Status IA:', data);
                
                const statusEl = document.getElementById('statusMessage');
                const badgeEl = document.getElementById('aiModeBadge');
                
                if (data.ai_demo_mode) {
                    statusEl.textContent = 'Sistema em modo demo. An√°lises gen√©ricas dispon√≠veis.';
                    badgeEl.textContent = 'Modo Demo';
                    badgeEl.className = 'badge badge-demo';
                } else if (data.facial_analysis_available) {
                    statusEl.textContent = 'An√°lise facial com IA ativada!';
                    badgeEl.textContent = 'IA Ativa';
                    badgeEl.className = 'badge badge-ai';
                }
            } catch (error) {
                console.error('‚ùå Erro status IA:', error);
            }
        }

        function setupFileUpload() {
            const fileUpload = document.getElementById('fileUpload');
            const fileInput = document.getElementById('photoInput');

            fileUpload.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    console.log('üìÅ Arquivo:', file.name);
                    
                    fileUpload.querySelector('div').innerHTML = `
                        <p style="font-size: 48px;">‚úÖ</p>
                        <p style="font-weight: 600;">Foto: ${file.name}</p>
                        <p style="font-size: 12px; color: #718096;">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                    `;
                }
            });

            fileUpload.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUpload.classList.add('drag-over');
            });

            fileUpload.addEventListener('dragleave', () => {
                fileUpload.classList.remove('drag-over');
            });

            fileUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUpload.classList.remove('drag-over');
                
                if (e.dataTransfer.files.length > 0) {
                    fileInput.files = e.dataTransfer.files;
                    fileInput.dispatchEvent(new Event('change'));
                }
            });
        }

        async function analyzePhoto() {
            const fileInput = document.getElementById('photoInput');
            const useProfilePhoto = document.getElementById('useProfilePhoto').checked;
            
            if (!fileInput.files[0] && !useProfilePhoto) {
                alert('Selecione uma foto ou marque "Usar foto de perfil"');
                return;
            }

            if (!authToken) {
                handleSessionExpired();
                return;
            }

            document.getElementById('analyzeText').classList.add('hidden');
            document.getElementById('analyzeLoading').classList.remove('hidden');
            document.getElementById('analyzeBtn').disabled = true;

            try {
                const formData = new FormData();
                
                if (fileInput.files[0]) {
                    formData.append('file', fileInput.files[0]);
                }
                
                const url = `${API_BASE}/ai/analyze?use_profile_photo=${useProfilePhoto}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: formData
                });

                if (response.status === 401) {
                    handleSessionExpired();
                    return;
                }

                if (!response.ok) {
                    throw new Error(`Erro ${response.status}`);
                }

                const data = await response.json();
                displayAnalysisResults(data);

            } catch (error) {
                console.error('‚ùå Erro:', error);
                alert(`Erro: ${error.message}`);
            } finally {
                document.getElementById('analyzeText').classList.remove('hidden');
                document.getElementById('analyzeLoading').classList.add('hidden');
                document.getElementById('analyzeBtn').disabled = false;
            }
        }

        function displayAnalysisResults(data) {
            window.currentRecommendations = data;
            
            document.getElementById('faceShape').textContent = data.formato_rosto.toUpperCase();
            document.getElementById('skinTone').textContent = data.tom_pele.toUpperCase();
            document.getElementById('confidence').textContent = ((data.confianca || 0) * 100).toFixed(0);

            const cutsEl = document.getElementById('recommendedCuts');
            cutsEl.innerHTML = '';
            (data.cortes_sugeridos || []).slice(0, 5).forEach(cut => {
                const li = document.createElement('li');
                li.textContent = cut;
                cutsEl.appendChild(li);
            });

            const colorsEl = document.getElementById('recommendedColors');
            colorsEl.innerHTML = '';
            (data.cores_sugeridas || []).slice(0, 5).forEach(color => {
                const li = document.createElement('li');
                li.textContent = color;
                colorsEl.appendChild(li);
            });

            const tipsEl = document.getElementById('styleTips');
            tipsEl.innerHTML = '';
            (data.dicas_estilo || []).slice(0, 3).forEach(tip => {
                const li = document.createElement('li');
                li.textContent = tip;
                tipsEl.appendChild(li);
            });

            document.getElementById('analysisResults').classList.remove('hidden');
            
            addActionButtons();
            
            document.getElementById('analysisResults').scrollIntoView({ behavior: 'smooth' });
        }

        // ==================== DADOS DOS SERVI√áOS ====================

        const SERVICES_DATA = {
            cortes: [
                { id: 'corte_feminino', name: 'Corte Feminino', duration: 60, price: 25 },
                { id: 'corte_masculino', name: 'Corte Masculino', duration: 30, price: 15 },
                { id: 'corte_infantil', name: 'Corte Infantil', duration: 30, price: 12 },
                { id: 'long_bob', name: 'Long Bob', duration: 60, price: 25 },
                { id: 'franja', name: 'Franja', duration: 15, price: 8 }
            ],
            coloracao: [
                { id: 'coloracao_completa', name: 'Colora√ß√£o Completa', duration: 120, price: 45, requiresTest: true },
                { id: 'retoque_raiz', name: 'Retoque de Raiz', duration: 90, price: 30, requiresTest: true },
                { id: 'luzes_mechas', name: 'Luzes/Mechas', duration: 180, price: 60, requiresTest: true },
                { id: 'balayage', name: 'Balayage', duration: 150, price: 70, requiresTest: true },
                { id: 'reflexos', name: 'Reflexos', duration: 90, price: 35, requiresTest: true }
            ],
            tratamentos: [
                { id: 'hidratacao', name: 'Hidrata√ß√£o Profunda', duration: 90, price: 35 },
                { id: 'cauterizacao', name: 'Cauteriza√ß√£o', duration: 120, price: 45, requiresTest: true },
                { id: 'reconstrucao', name: 'Reconstru√ß√£o', duration: 120, price: 50, requiresTest: true },
                { id: 'botox', name: 'Botox Capilar', duration: 150, price: 60, requiresTest: true }
            ],
            outros: [
                { id: 'escova', name: 'Escova', duration: 45, price: 20 },
                { id: 'penteado', name: 'Penteado', duration: 60, price: 30 },
                { id: 'maquiagem', name: 'Maquiagem', duration: 60, price: 40 }
            ]
        };

        let selectedServices = [];

        // ==================== BOT√ïES DE A√á√ÉO AP√ìS AN√ÅLISE ====================

        function addActionButtons() {
            const resultsDiv = document.getElementById('analysisResults');
            const existing = document.getElementById('actionButtons');
            if (existing) existing.remove();
            
            const actionsDiv = document.createElement('div');
            actionsDiv.id = 'actionButtons';
            actionsDiv.style.cssText = 'margin-top: 30px; padding: 20px; background: #f7fafc; border-radius: 12px; border-left: 4px solid #667eea;';
            
            actionsDiv.innerHTML = `
                <h4 style="color: #667eea; margin-bottom: 15px;">üìÖ Pr√≥ximos Passos</h4>
                <p style="color: #666; margin-bottom: 20px;">
                    Gostou das recomenda√ß√µes? Escolha como deseja continuar:
                </p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="button" onclick="acceptAISuggestions()" style="background: #48bb78;">
                        ‚ú® Aceitar Sugest√µes da IA
                    </button>
                    <button class="button" onclick="showAllServices()" style="background: #667eea;">
                        üìã Ver Todos os Servi√ßos
                    </button>
                    <button class="button" onclick="analyzeAgain()" style="background: #ed8936;">
                        üîÑ Nova An√°lise
                    </button>
                </div>
            `;
            
            resultsDiv.appendChild(actionsDiv);
        }

        function acceptAISuggestions() {
            if (!window.currentRecommendations) {
                alert('‚ùå Nenhuma recomenda√ß√£o dispon√≠vel');
                return;
            }
            
            const recommendations = window.currentRecommendations;
            const suggestedServices = [];
            
            if (recommendations.cortes_sugeridos && recommendations.cortes_sugeridos.length > 0) {
                const cutName = recommendations.cortes_sugeridos[0];
                const foundService = findServiceByName(cutName);
                if (foundService) suggestedServices.push(foundService);
            }
            
            if (recommendations.cores_sugeridas && recommendations.cores_sugeridas.length > 0) {
                const colorService = SERVICES_DATA.coloracao[0];
                suggestedServices.push(colorService);
            }
            
            if (suggestedServices.length === 0) {
                alert('‚ö†Ô∏è N√£o foi poss√≠vel mapear as sugest√µes da IA. Use "Ver Todos os Servi√ßos".');
                return;
            }
            
            showServiceSelectionModal(suggestedServices, recommendations);
        }

        function findServiceByName(name) {
            const lowerName = name.toLowerCase();
            for (const category in SERVICES_DATA) {
                for (const service of SERVICES_DATA[category]) {
                    if (service.name.toLowerCase().includes(lowerName) || lowerName.includes(service.name.toLowerCase())) {
                        return service;
                    }
                }
            }
            return null;
        }

        function showAllServices() {
            showServiceSelectionModal([], null);
        }

        function analyzeAgain() {
            const fileInput = document.getElementById('photoInput');
            fileInput.value = '';
            
            const fileUpload = document.getElementById('fileUpload');
            fileUpload.querySelector('div').innerHTML = `
                <p style="font-size: 48px;">üì∑</p>
                <p style="font-weight: 600;">Clique ou arraste uma foto aqui</p>
                <p style="font-size: 12px; color: #718096;">PNG, JPG at√© 5MB</p>
            `;
            
            document.getElementById('useProfilePhoto').checked = false;
            document.getElementById('analysisResults').classList.add('hidden');
            fileUpload.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // ==================== MODAL DE SELE√á√ÉO DE SERVI√áOS ====================

        function showServiceSelectionModal(preSelectedServices = [], analysisData = null) {
            const existing = document.getElementById('servicesModal');
            if (existing) existing.remove();
            
            selectedServices = [...preSelectedServices];
            
            const modal = document.createElement('div');
            modal.id = 'servicesModal';
            modal.className = 'modal active';
            
            const categoryNames = {
                cortes: '‚úÇÔ∏è Cortes',
                coloracao: 'üé® Colora√ß√£o',
                tratamentos: 'üíÜ Tratamentos',
                outros: '‚ú® Outros Servi√ßos'
            };
            
            let servicesHtml = '';
            
            if (preSelectedServices.length > 0) {
                servicesHtml += `
                    <div class="alert alert-info" style="margin-bottom: 25px;">
                        <strong>‚ú® Sugest√µes da IA:</strong> Pr√©-selecionamos os servi√ßos recomendados. Voc√™ pode adicionar mais abaixo!
                    </div>
                `;
            }
            
            Object.entries(SERVICES_DATA).forEach(([category, services]) => {
                servicesHtml += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #667eea; margin-bottom: 15px; font-size: 18px;">
                            ${categoryNames[category]}
                        </h3>
                        <div style="display: grid; gap: 12px;">
                `;
                
                services.forEach(service => {
                    const checkboxId = `service_${service.id}`;
                    const isPreSelected = preSelectedServices.some(s => s.id === service.id);
                    
                    servicesHtml += `
                        <label for="${checkboxId}" style="display: flex; align-items: center; padding: 18px; border: 2px solid ${isPreSelected ? '#667eea' : '#e2e8f0'}; background: ${isPreSelected ? '#edf2f7' : 'white'}; border-radius: 12px; cursor: pointer;">
                            <input type="checkbox" id="${checkboxId}" ${isPreSelected ? 'checked' : ''} onchange="toggleService('${service.id}')" style="width: 22px; height: 22px; margin-right: 18px; cursor: pointer;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <strong style="color: #2d3748;">${service.name}</strong>
                                    ${isPreSelected ? '<span style="background: #48bb78; color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px;">‚ú® IA</span>' : ''}
                                    ${service.requiresTest ? '<span style="background: #ed8936; color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px;">‚ö†Ô∏è Teste 48h</span>' : ''}
                                </div>
                                <div style="color: #718096; font-size: 15px;">
                                    ‚è±Ô∏è ${service.duration} min | üí∞ ‚Ç¨${service.price}
                                </div>
                            </div>
                        </label>
                    `;
                });
                
                servicesHtml += '</div></div>';
            });
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; text-align: left;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px; position: sticky; top: 0; background: white; padding-bottom: 15px; border-bottom: 2px solid #e2e8f0; z-index: 10;">
                        <h2 style="color: #667eea; margin: 0;">‚ú® Selecione os Servi√ßos</h2>
                        <button onclick="closeServicesModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #718096;">√ó</button>
                    </div>
                    
                    ${servicesHtml}
                    
                    <div style="position: sticky; bottom: 0; background: white; border-top: 2px solid #e2e8f0; padding-top: 20px; margin-top: 30px; z-index: 10;">
                        <div style="background: #f7fafc; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between;">
                                <div>
                                    <div style="color: #718096; font-size: 13px;">Total</div>
                                    <span id="totalPrice" style="font-size: 32px; font-weight: 700; color: #667eea;">‚Ç¨0</span>
                                </div>
                                <div style="text-align: right;">
                                    <div style="color: #718096; font-size: 14px;"><span id="totalDuration">0 min</span></div>
                                    <div style="color: #718096; font-size: 14px;"><span id="totalServices">0 servi√ßos</span></div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="testWarning" style="display: none; background: #fff5f5; border: 2px solid #fc8181; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                            <strong style="color: #c53030;">‚ö†Ô∏è Aten√ß√£o:</strong> Alguns servi√ßos requerem teste de mecha 48h antes.
                        </div>
                        
                        <div style="display: flex; gap: 12px;">
                            <button onclick="closeServicesModal()" class="button" style="flex: 1; background: #e2e8f0; color: #2d3748;">Cancelar</button>
                            <button onclick="confirmServices()" class="button" style="flex: 2;">üìÖ Continuar para Agendamento</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            updateCartSummary();
        }

        function findServiceById(id) {
            for (const category in SERVICES_DATA) {
                const service = SERVICES_DATA[category].find(s => s.id === id);
                if (service) return service;
            }
            return null;
        }

        function toggleService(serviceId) {
            const service = findServiceById(serviceId);
            if (!service) return;
            
            const index = selectedServices.findIndex(s => s.id === serviceId);
            if (index >= 0) {
                selectedServices.splice(index, 1);
            } else {
                selectedServices.push(service);
            }
            
            updateCartSummary();
        }

        function updateCartSummary() {
            const totalPrice = selectedServices.reduce((sum, s) => sum + s.price, 0);
            const totalDuration = selectedServices.reduce((sum, s) => sum + s.duration, 0);
            const hasTestRequired = selectedServices.some(s => s.requiresTest);
            
            document.getElementById('totalPrice').textContent = `‚Ç¨${totalPrice}`;
            document.getElementById('totalDuration').textContent = `${totalDuration} min`;
            document.getElementById('totalServices').textContent = `${selectedServices.length} servi√ßo${selectedServices.length !== 1 ? 's' : ''}`;
            
            const testWarning = document.getElementById('testWarning');
            testWarning.style.display = hasTestRequired ? 'block' : 'none';
        }

        function closeServicesModal() {
            const modal = document.getElementById('servicesModal');
            if (modal) modal.remove();
            selectedServices = [];
        }

        function confirmServices() {
            if (selectedServices.length === 0) {
                alert('‚ö†Ô∏è Selecione pelo menos um servi√ßo!');
                return;
            }
            
            const hasTestRequired = selectedServices.some(s => s.requiresTest);
            const servicesToSave = [...selectedServices];
            
            closeServicesModal();
            
            // CORRE√á√ÉO: Verificar se precisa de question√°rio m√©dico ANTES de agendar
            if (hasTestRequired) {
                window.pendingServices = servicesToSave;
                showMedicalQuestionnaire();
            } else {
                // Sem servi√ßos que requerem teste, vai direto para agendamento
                proceedToDateSelection(servicesToSave, null);
            }
        }

        // ==================== QUESTION√ÅRIO M√âDICO (ANTES DE AGENDAR) ====================

        function showMedicalQuestionnaire() {
            const existing = document.getElementById('medicalModal');
            if (existing) existing.remove();
            
            const modal = document.createElement('div');
            modal.id = 'medicalModal';
            modal.className = 'modal active';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto; text-align: left;">
                    <h2 style="color: #667eea; margin-bottom: 20px;">üìã Question√°rio de Sa√∫de Capilar</h2>
                    
                    <div class="alert alert-danger" style="margin-bottom: 25px;">
                        <strong>‚ö†Ô∏è Importante:</strong> Responda com sinceridade para sua seguran√ßa. Este question√°rio √© obrigat√≥rio para servi√ßos qu√≠micos.
                    </div>
                    
                    <form id="medicalForm">
                        <div style="margin-bottom: 20px; padding: 20px; background: #f7fafc; border-radius: 12px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 12px;">1. Tem alergia a produtos qu√≠micos?</label>
                            <div style="display: flex; gap: 15px; margin-bottom: 10px;">
                                <label><input type="radio" name="q1" value="sim" required> Sim</label>
                                <label><input type="radio" name="q1" value="nao" required> N√£o</label>
                            </div>
                            <input type="text" id="q1_details" placeholder="Especifique quais..." style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; display: none;">
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 20px; background: #f7fafc; border-radius: 12px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 12px;">2. J√° teve rea√ß√£o al√©rgica a colora√ß√£o?</label>
                            <div style="display: flex; gap: 15px;">
                                <label><input type="radio" name="q2" value="sim" required> Sim</label>
                                <label><input type="radio" name="q2" value="nao" required> N√£o</label>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 20px; background: #f7fafc; border-radius: 12px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 12px;">3. Fez procedimento qu√≠mico nos √∫ltimos 15 dias?</label>
                            <div style="display: flex; gap: 15px; margin-bottom: 10px;">
                                <label><input type="radio" name="q3" value="sim" required> Sim</label>
                                <label><input type="radio" name="q3" value="nao" required> N√£o</label>
                            </div>
                            <input type="text" id="q3_details" placeholder="Qual procedimento?" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; display: none;">
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 20px; background: #f7fafc; border-radius: 12px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 12px;">4. Couro cabeludo sens√≠vel ou irritado?</label>
                            <div style="display: flex; gap: 15px;">
                                <label><input type="radio" name="q4" value="sim" required> Sim</label>
                                <label><input type="radio" name="q4" value="nao" required> N√£o</label>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 20px; background: #f7fafc; border-radius: 12px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 12px;">5. Est√° gr√°vida ou amamentando?</label>
                            <div style="display: flex; gap: 15px;">
                                <label><input type="radio" name="q5" value="sim" required> Sim</label>
                                <label><input type="radio" name="q5" value="nao" required> N√£o</label>
                                <label><input type="radio" name="q5" value="na" required> N/A</label>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 20px; background: #f7fafc; border-radius: 12px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 12px;">Observa√ß√µes (opcional)</label>
                            <textarea id="observations" rows="3" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;" placeholder="Alguma informa√ß√£o adicional que devemos saber?"></textarea>
                        </div>
                        
                        <div style="padding: 20px; background: #f0fff4; border: 2px solid #48bb78; border-radius: 12px; margin-bottom: 20px;">
                            <label style="display: flex; gap: 12px;">
                                <input type="checkbox" id="acceptTerms" required style="width: 20px; height: 20px;">
                                <span style="font-size: 14px;">Declaro que as informa√ß√µes s√£o verdadeiras e autorizo o teste de mecha 48h antes do procedimento.</span>
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 12px;">
                            <button type="button" onclick="closeMedicalModal()" class="button" style="flex: 1; background: #e2e8f0; color: #2d3748;">Cancelar</button>
                            <button type="submit" class="button" style="flex: 2;">‚úÖ Confirmar e Continuar</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Event listeners para mostrar campos de detalhe
            document.querySelector('input[name="q1"][value="sim"]').onchange = () => document.getElementById('q1_details').style.display = 'block';
            document.querySelector('input[name="q1"][value="nao"]').onchange = () => document.getElementById('q1_details').style.display = 'none';
            document.querySelector('input[name="q3"][value="sim"]').onchange = () => document.getElementById('q3_details').style.display = 'block';
            document.querySelector('input[name="q3"][value="nao"]').onchange = () => document.getElementById('q3_details').style.display = 'none';
            
            document.getElementById('medicalForm').onsubmit = (e) => {
                e.preventDefault();
                validateAndProceedWithMedicalData();
            };
        }

        function validateAndProceedWithMedicalData() {
            const q2 = document.querySelector('input[name="q2"]:checked').value;
            const q4 = document.querySelector('input[name="q4"]:checked').value;
            
            // VALIDA√á√ÉO: Se teve rea√ß√£o al√©rgica OU couro cabeludo irritado, N√ÉO PODE PROSSEGUIR
            if (q2 === 'sim' || q4 === 'sim') {
                alert('‚ö†Ô∏è ATEN√á√ÉO!\n\nPara sua seguran√ßa, n√£o podemos realizar procedimentos qu√≠micos.\n\nRecomendamos consultar um dermatologista primeiro.');
                closeMedicalModal();
                return;
            }
            
            // Coletar dados do question√°rio
            const medicalData = {
                q1: document.querySelector('input[name="q1"]:checked').value,
                q1_details: document.getElementById('q1_details').value,
                q2: q2,
                q3: document.querySelector('input[name="q3"]:checked').value,
                q3_details: document.getElementById('q3_details').value,
                q4: q4,
                q5: document.querySelector('input[name="q5"]:checked').value,
                observations: document.getElementById('observations').value,
                timestamp: new Date().toISOString()
            };
            
            const servicesToBook = window.pendingServices;
            closeMedicalModal();
            
            // CORRE√á√ÉO: Ap√≥s question√°rio m√©dico, vai para sele√ß√£o de data/hora
            proceedToDateSelection(servicesToBook, medicalData);
        }

        function closeMedicalModal() {
            const modal = document.getElementById('medicalModal');
            if (modal) modal.remove();
        }

        // ==================== SELETOR DE DATA/HORA ====================

        function proceedToDateSelection(services, medicalData) {
            if (!services || services.length === 0) {
                alert('‚ùå Erro: Nenhum servi√ßo selecionado.');
                return;
            }
            
            const bookingCode = 'BK-' + Date.now();
            showDateTimeSelector(bookingCode, services, medicalData);
        }

        function showDateTimeSelector(bookingCode, services, medicalData) {
            const existing = document.getElementById('dateTimeModal');
            if (existing) existing.remove();
            
            const modal = document.createElement('div');
            modal.id = 'dateTimeModal';
            modal.className = 'modal active';
            
            const totalPrice = services.reduce((sum, s) => sum + s.price, 0);
            const totalDuration = services.reduce((sum, s) => sum + s.duration, 0);
            const requiresTest = services.some(s => s.requiresTest);
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px; text-align: left;">
                    <h2 style="color: #667eea; margin-bottom: 10px;">üìÖ Agendar Data e Hora</h2>
                    <p style="color: #718096; margin-bottom: 20px;">C√≥digo: <strong>${bookingCode}</strong></p>
                    
                    <div style="background: #f7fafc; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                        <strong>üìã Servi√ßos:</strong>
                        <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                            ${services.map(s => `<li>${s.name} (${s.duration}min - ‚Ç¨${s.price})</li>`).join('')}
                        </ul>
                        <div style="margin-top: 10px;">
                            <strong>üí∞ Total:</strong> ‚Ç¨${totalPrice} | 
                            <strong>‚è±Ô∏è Dura√ß√£o:</strong> ${Math.floor(totalDuration/60)}h ${totalDuration%60}min
                        </div>
                    </div>
                    
                    ${requiresTest ? `
                        <div class="alert alert-warning" style="margin-bottom: 20px;">
                            <strong>‚ö†Ô∏è Lembre-se:</strong> √â necess√°rio fazer teste de mecha 48h ANTES deste agendamento! Agende uma data com pelo menos 2 dias de anteced√™ncia.
                        </div>
                    ` : ''}
                    
                    <form id="dateTimeForm">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px;">Data:</label>
                            <input type="date" id="appointmentDate" required 
                                   min="${getMinDate(requiresTest)}"
                                   style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px;">Hora:</label>
                            <select id="appointmentTime" required style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
                                <option value="">Selecione a data primeiro...</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px;">Observa√ß√µes (opcional):</label>
                            <textarea id="appointmentNotes" rows="3" placeholder="Algum pedido especial?" 
                                      style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px;"></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 12px;">
                            <button type="button" onclick="closeDateTimeModal()" class="button" style="flex: 1; background: #e2e8f0; color: #2d3748;">Cancelar</button>
                            <button type="submit" class="button" style="flex: 2;">‚úÖ Confirmar Agendamento</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('appointmentDate').addEventListener('change', loadAvailableSlots);
            document.getElementById('dateTimeForm').addEventListener('submit', (e) => {
                e.preventDefault();
                confirmSchedule(bookingCode, services, medicalData);
            });
        }

        function getMinDate(requiresTest) {
            const today = new Date();
            if (requiresTest) {
                // Se requer teste, m√≠nimo 3 dias (48h + margem)
                today.setDate(today.getDate() + 3);
            } else {
                // Sem teste, pode agendar a partir de amanh√£
                today.setDate(today.getDate() + 1);
            }
            return today.toISOString().split('T')[0];
        }

        function loadAvailableSlots() {
            const dateInput = document.getElementById('appointmentDate');
            const timeSelect = document.getElementById('appointmentTime');
            
            if (!dateInput.value) return;
            
            timeSelect.innerHTML = '<option value="">Selecione um hor√°rio</option>';
            for (let hour = 9; hour < 18; hour++) {
                ['00', '30'].forEach(minute => {
                    const time = `${hour.toString().padStart(2, '0')}:${minute}`;
                    const option = document.createElement('option');
                    option.value = time;
                    option.textContent = time;
                    timeSelect.appendChild(option);
                });
            }
        }

        function confirmSchedule(bookingCode, services, medicalData) {
            const date = document.getElementById('appointmentDate').value;
            const time = document.getElementById('appointmentTime').value;
            const notes = document.getElementById('appointmentNotes').value;
            
            if (!time) {
                alert('‚ö†Ô∏è Selecione um hor√°rio!');
                return;
            }
            
            const totalPrice = services.reduce((sum, s) => sum + s.price, 0);
            const totalDuration = services.reduce((sum, s) => sum + s.duration, 0);
            
            const appointment = {
                booking_code: bookingCode,
                appointment_date: date,
                appointment_time: time,
                notes: notes,
                services: services,
                total_price: totalPrice,
                total_duration: totalDuration,
                requires_test: services.some(s => s.requiresTest),
                medical_questionnaire: medicalData,
                analysis_data: window.currentRecommendations || null,
                status: 'scheduled',
                created_at: new Date().toISOString()
            };
            
            // Salvar no localStorage
            let appointments = JSON.parse(localStorage.getItem('user_appointments') || '[]');
            appointments.push(appointment);
            localStorage.setItem('user_appointments', JSON.stringify(appointments));
            
            closeDateTimeModal();
            
            // Mensagem de confirma√ß√£o
            const testWarning = appointment.requires_test ? '\n\n‚ö†Ô∏è IMPORTANTE: N√£o esque√ßa o teste de mecha 48h antes!' : '';
            alert(`‚úÖ AGENDAMENTO CONFIRMADO!\n\nüìÖ Data: ${date}\n‚è∞ Hora: ${time}\nüé´ C√≥digo: ${bookingCode}${testWarning}`);
            
            // Redirecionar para tela de agendamentos
            showAppointmentsScreen();
        }

        function closeDateTimeModal() {
            const modal = document.getElementById('dateTimeModal');
            if (modal) modal.remove();
        }

        // ==================== TELA DE AGENDAMENTOS ====================

        function showAppointmentsScreen() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('appointmentsScreen').style.display = 'block';
            loadAppointmentsForScreen();
        }

        function hideAppointmentsScreen() {
            document.getElementById('appointmentsScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
        }

        function loadAppointmentsForScreen() {
            const appointments = JSON.parse(localStorage.getItem('user_appointments') || '[]');
            const container = document.getElementById('appointmentsListScreen');
            
            if (appointments.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 64px; margin-bottom: 20px;">üìÖ</div>
                        <h3 style="color: #2d3748; margin-bottom: 10px;">Nenhum agendamento ainda</h3>
                        <p style="margin-bottom: 30px; color: #718096;">Fa√ßa sua an√°lise facial e agende um hor√°rio!</p>
                        <button onclick="startNewBooking()" class="button">
                            ‚ûï Novo Agendamento
                        </button>
                    </div>
                `;
                return;
            }
            
            appointments.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            container.innerHTML = appointments.map((apt, index) => {
                const date = new Date(apt.appointment_date);
                const formattedDate = date.toLocaleDateString('pt-PT');
                const statusColor = apt.status === 'scheduled' ? '#48bb78' : '#fc8181';
                const statusText = apt.status === 'scheduled' ? 'AGENDADO' : 'CANCELADO';
                
                return `
                    <div style="background: white; border: 3px solid ${statusColor}; border-radius: 16px; padding: 24px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid #f7fafc;">
                            <div>
                                <h3 style="margin: 0; color: #667eea; font-size: 18px;">${apt.services[0].name}</h3>
                                ${apt.services.length > 1 ? `<p style="margin: 4px 0 0 0; color: #718096; font-size: 13px;">+${apt.services.length-1} servi√ßo(s)</p>` : ''}
                            </div>
                            <div style="background: ${statusColor}; color: white; padding: 8px 16px; border-radius: 20px; font-weight: 700; font-size: 12px;">
                                ${statusText}
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 20px;">
                            <div style="background: #f7fafc; padding: 12px; border-radius: 8px;">
                                <div style="color: #718096; font-size: 12px; font-weight: 600; margin-bottom: 4px;">üìÖ DATA</div>
                                <div style="color: #2d3748; font-size: 16px; font-weight: 700;">${formattedDate}</div>
                            </div>
                            <div style="background: #f7fafc; padding: 12px; border-radius: 8px;">
                                <div style="color: #718096; font-size: 12px; font-weight: 600; margin-bottom: 4px;">üïê HOR√ÅRIO</div>
                                <div style="color: #2d3748; font-size: 16px; font-weight: 700;">${apt.appointment_time}</div>
                            </div>
                            <div style="background: #f7fafc; padding: 12px; border-radius: 8px;">
                                <div style="color: #718096; font-size: 12px; font-weight: 600; margin-bottom: 4px;">üí∞ VALOR</div>
                                <div style="color: #2d3748; font-size: 16px; font-weight: 700;">‚Ç¨${apt.total_price}</div>
                            </div>
                            <div style="background: #f7fafc; padding: 12px; border-radius: 8px;">
                                <div style="color: #718096; font-size: 12px; font-weight: 600; margin-bottom: 4px;">‚è±Ô∏è DURA√á√ÉO</div>
                                <div style="color: #2d3748; font-size: 16px; font-weight: 700;">${Math.floor(apt.total_duration/60)}h ${apt.total_duration%60}m</div>
                            </div>
                        </div>
                        
                        ${apt.requires_test ? `
                            <div class="alert alert-warning" style="margin-bottom: 16px;">
                                <strong>‚ö†Ô∏è Teste de Mecha:</strong> Necess√°rio 48h antes do procedimento
                            </div>
                        ` : ''}
                        
                        <div style="background: #edf2f7; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                            <strong style="color: #4a5568; font-size: 13px;">‚ú® SERVI√áOS:</strong>
                            <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                                ${apt.services.map(s => `<li style="color: #2d3748; font-size: 14px;">${s.name}</li>`).join('')}
                            </ul>
                        </div>
                        
                        ${apt.status === 'scheduled' ? `
                            <div style="display: flex; gap: 12px; padding-top: 16px; border-top: 2px solid #f7fafc;">
                                <button onclick="showAppointmentDetails(${index})" class="button" style="flex: 1;">
                                    üëÅÔ∏è Ver Detalhes
                                </button>
                                <button onclick="cancelAppointmentFromScreen(${index})" 
                                        style="flex: 1; padding: 12px; background: #fed7d7; color: #c53030; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                    ‚ùå Cancelar
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function showAppointmentDetails(index) {
            const appointments = JSON.parse(localStorage.getItem('user_appointments') || '[]');
            const apt = appointments[index];
            
            const servicesText = apt.services.map(s => `‚Ä¢ ${s.name} (${s.duration}min - ‚Ç¨${s.price})`).join('\n');
            const medicalInfo = apt.medical_questionnaire ? '\n\n‚úÖ Question√°rio m√©dico preenchido' : '';
            
            alert(`üìã DETALHES DO AGENDAMENTO\n\nüé´ C√≥digo: ${apt.booking_code}\nüìÖ Data: ${apt.appointment_date}\nüïê Hora: ${apt.appointment_time}\n\n‚ú® Servi√ßos:\n${servicesText}\n\nüí∞ Total: ‚Ç¨${apt.total_price}\n‚è±Ô∏è Dura√ß√£o: ${Math.floor(apt.total_duration/60)}h ${apt.total_duration%60}min${apt.notes ? '\n\nüìù Observa√ß√µes: ' + apt.notes : ''}${medicalInfo}`);
        }

        function cancelAppointmentFromScreen(index) {
            if (!confirm('Tem certeza que deseja cancelar este agendamento?')) return;
            
            let appointments = JSON.parse(localStorage.getItem('user_appointments') || '[]');
            appointments[index].status = 'cancelled';
            appointments[index].cancelled_at = new Date().toISOString();
            localStorage.setItem('user_appointments', JSON.stringify(appointments));
            
            alert('‚úÖ Agendamento cancelado com sucesso!');
            loadAppointmentsForScreen();
        }

        function startNewBooking() {
            hideAppointmentsScreen();
            document.getElementById('fileUpload').scrollIntoView({ behavior: 'smooth' });
        }

    </script>
</body>
</html>